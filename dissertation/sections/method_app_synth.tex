%! TEX root = ../dissertation_gurecky.tex


\section{Generating Synthetic Data}

The synthetic data was generated by a first running standalone CTF on a single quarter symmetric pin and then augmenting the CTF result with user tailored noise.  A synthetic data generation tool allows absolute control over the properties of joint distribution of TH boundary conditions which are fed into the crud simulation code.  Since the synthetic data has known properties, this data serves as an important data source for benchmarking and validation operations.  In this chapter we do not introduce any machine learning components and therefore, the copula and marginal models presented are not predictive but are reconstructions of the original synthetic data source.  Here, we quantify the quality of these reconstructions.

A synthetic data generation tool was developed in Python to generate the synthetic data.  The copula family, Kendall's $\tau$ rank correlation coefficient and marginal distribution parameters are specified as a function of axial location and local TH conditions supplied by CTF.  It is important to note that the synthetic CFD data generation tool does not capture spatial auto-correlation of the surface fields.  It does not reflect true the physics of fluid flow.

To generate synthetic data, CTF results are augmented by user controlled noise distributed according to
$ \varepsilon(z, \theta)$
and potentially shifted by a user set bias,
$ b(z)$ where $z$ is the axial position along the rod.
$\theta$ represents user specified distribution parameters.
\begin{equation}
T(z) = \mu_{ctf}(z) + \varepsilon (z; \theta) +  b(z)
\end{equation}


The availability of synthetic data alleviates the need to generate comparatively expensive CFD results to test the hi2lo strategy.  Some aspects of CFD field are preserved, including expected biases between CFD and CTF results that arise due to discrepancies in wall heat transfer closure models, among other differences [ref], additionally turbulent dispersion of the temperature and surface shear distributions around spacer grids are specified.  Accounting for spatial auto-correlation in the surface fields was not pursued since the hi2lo procedures do not seek to preserve fine scale spatial features.  Any spatial autocorrelation present within a CTF face is lost.  The synthetic data is not a direct replacement to CFD data but serves as data source for integration testing.

After synthetic data is generated, non-parametric margins are fit to the temperature, TKE, and boundary heat flux synthetic sample distributions.  Copula are fit to the synthetic data based on maximum likelihood and the Akiki information criterion. 

\subsection{Single Pin Synthetic Data Set}

The original baseline CTF results are shown in figures \ref{fig:ctf_twall_orig} and \ref{fig:ctf_tke_orig}.  The baseline CTF pin parameters are provided in table \ref{tab:pin_settings}.  The CTF result was produced from a quarter symmetric case, and therefore no azimuthal variation is observed.

\begin{table}[h]
    \begin{center}
        \caption{Single pin reference thermal hydraulic boundary conditions.}
        \begin{tabular}{|l|l|l|}
            \hline
            Setting & Value & Unit \\
            \hline
            Inlet Flow Rate & 0.3 & $[kg/s]$ \\
            Inlet Temperature & 565 & $[K]$ \\
            Pressure & 2250 & $[psia]$ \\
            Rod Outer Radius & 0.425 & $[cm]$ \\
            Pin Pitch & 1.26 & $[cm]$ \\
            Power Shape & constant & $[]$ \\
            Heat Flux & 85.86  & $[W/m^2]$ \\
            Rod Height & 3.6275 & $[m]$ \\
            Number of Grids & 3  & $[]$ \\
            Grid Locations & 2.0, 2.4, 2.8 & $[m]$ \\
            \hline
        \end{tabular}
    \label{tab:pin_settings}
    \end{center}
\end{table}

\begin{figure}[H]%
    \centering
    \subfloat[Axial CTF cladding surface temperature result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/ctf_asm0_z_twall} }}%
    \qquad
    \subfloat[2D rod map of CTF result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/ctf_pin_h5_temperature} }}%
    \caption[Single pin CTF baseline temperature result.  160\% nominal power conditions.]{Single pin CTF baseline temperature result.  160\% nominal power conditions.}%
    \label{fig:ctf_twall_orig}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[Axial CTF cladding surface TKE result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/ctf_asm0_z_tke} }}%
    \qquad
    \subfloat[2D rod map of CTF result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/ctf_pin_h5_tke} }}%
    \caption[Single pin CTF baseline TKE result.  160\% nominal power conditions.]{Single pin CTF baseline TKE result.  160\% nominal power conditions.}%
    \label{fig:ctf_tke_orig}%
\end{figure}


The boundary heat flux was assumed to be constant at $85.86 [W/cm^2]$ which corresponds to approximately 160\% nominal PWR power conditions.

Next synthetic noise was generated according to table \ref{tab:synth_settings}.  The complete synthetic data generation code and input deck is provided in Appendix ().

\begin{table}[h]
    \begin{center}
        \caption{Per-span synthetic data generation settings.}
        \begin{tabular}{|l|l|l|l|l|}
            \hline
            \bf Span 1 & Node & Node location & Copula Settings  & Margin Settings \\
            \hline
            $N$: 8000  & 1  & 0.0 & $\Theta_c:$ Gaussian, $\theta:-0.6$ &  T:$\beta(5.0, 5.0)$ , k: $\mathcal{N}(0, 0.001)$ \\
                   & 2  & 2.0 & $\Theta_c:$ Gaussian, $\theta:-0.6$ &  T:$\beta(5.0, 5.0)$ , k: $\mathcal{N}(0, 0.001)$   \\     
            \hline \hline
            \bf Span 2 & Node & Node location & Copula Settings  & Margin Settings \\
            \hline
             $N$: 8000 & 1  & 2.0 & $\Theta_c:$ Clayton-90, $\theta: 2.0$ &  T:$\beta(5.0, 2.7)$ , k: $\beta(1.75, 5.0)$ \\
            & 2  & 2.4 & $\Theta_c:$ Frank-90, $\theta: 8.0$ &  T:$\beta(5.0, 1.5)$ , k: $\beta(1.75, 5.0)$   \\     
            \hline \hline
            \bf Span 3 & Node & Node location & Copula Settings  & Margin Settings \\
            \hline
             $N$: 8000 & 1  & 2.4 & $\Theta_c:$ Clayton-90, $\theta: 2.0$ &  T:$\beta(5.0, 2.7)$ , k: $\beta(1.75, 5.0)$ \\
            & 2  & 2.8 & $\Theta_c:$ Frank-90, $\theta: 8.0$ &  T:$\beta(5.0, 1.5)$ , k: $\beta(1.75, 5.0)$   \\      
            \hline \hline
            \bf Span 4 & Node & Node location & Copula Settings  & Margin Settings \\
            \hline
            $N$: 8000 & 1  & 2.8 & $\Theta_c:$ Clayton-90, $\theta: 2.0$ &  T:$\beta(5.0, 2.7)$ , k: $\beta(1.75, 5.0)$ \\
            & 2  & 3.6 & $\Theta_c:$ Frank-90, $\theta: 8.0$ &  T:$\beta(5.0, 1.5)$ , k: $\beta(1.75, 5.0)$   \\     
            \hline      
        \end{tabular}
        \label{tab:synth_settings}
    \end{center}
\end{table}

In each span a separate copula mixture model is defined.  Samples are drawn with probability equal to the distance to the nearest node.  This enables one to change the behavior of the temperature and TKE margins and copula as a function of axial position on the rod.

After the copula models are sampled in each span, the original CTF result was augmented with the synthetically generated noise.


\begin{figure}[H]%
    \centering
    \subfloat[Spatial axial augmented CTF result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/pinH5TempOut} }}%
    \qquad
    \subfloat[2D rod map of sythetically augmented CTF result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/cfd_pin_temperature} }}%
    \caption[Augmented CFD result.]{Augmented CTF temperature result.}%
    \label{fig:ctf_twall_aug}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[Spatial axial augmented CTF result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/pinH5TkeOut} }}%
    \qquad
    \subfloat[2D rod map of sythetically augmented CTF result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/cfd_pin_tke} }}%
    \caption[Augmented CFD TKE result.]{Augmented CTF TKE result.}%
    \label{fig:ctf_tke_aug}%
\end{figure}





\section{Single Pin Comparisons}


\begin{itemize}
	\item (\checkmark) Compare CTF vs Synthetic CFD vs Hi2Lo Reconstructed CRUD results for a full pin for fixed TH conditions.
	\item (\checkmark) Show sensitivity of integrated crud mass and boron to the following.  Also show impact on uncertainty in these integrated results to:
	\begin{itemize}
		\item (\checkmark) Increase the number of samples drawn per patch
		\item (\checkmark) Force Gaussian copula vs. best fit copula approach.
	\end{itemize}
\end{itemize}

For the synthetic single pin data the difference between hi2lo and CTF predicted fractional surface area above a saturation temperature threshold ($T_{sat}$) is shown in figure \ref{fig:frac_a}.   CTF
is unable to capture small scale effects of the mixing vanes on the surface temperature distribution.

\begin{figure}[H]%
    \centering
    \subfloat[CTF predicted fractional area of each CTF face above the saturation point.]{{\includegraphics[width=0.45\linewidth]{figs/synth/hi2lo/ctf_pin_t_threshold} }}%
    \qquad
    \subfloat[Hi2lo predicted fractional area of each CTF face above the saturation point.]{{\includegraphics[width=0.45\linewidth]{figs/synth/hi2lo/hi2lo_pin_t_threshold} }}%
    \caption[]{Fraction area above the saturation point prediction comparison for the synthetic data set.}%
    \label{fig:frac_a}%
\end{figure}

The more significant the temperature thresholding behavior of the crud, the more important figure \ref{fig:frac_a} becomes with respect to computing the correct crud deposition rate on any given CTF surface.  This importance of this figure is echoed in figure (), which shows that a CTF and crud coupling without a hi2lo treatment of spacer grid effects might miss thresholding behavior entirely.

\begin{figure}[H]%
    \centering
    \subfloat[Hi2lo patch cladding wall temperature spatial distrubtion]{{\includegraphics[width=0.45\linewidth]{figs/synth/hi2lo/hi2lo_patch_t} }}%
    \qquad
    \subfloat[Hi2lo patch TKE spatial distrubtion.]{{\includegraphics[width=0.45\linewidth]{figs/synth/hi2lo/hi2lo_patch_tke} }}%
    \caption[]{Single hi2lo patch sample reordering demonstration.}%
    \label{fig:reshuffle_a}%
\end{figure}


\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{figs/synth/hi2lo/hi2lo_pin_cmass}
    \caption{Single pin crud mass distribution from synthetic TH data at 160\% nominal power conditions.}
    \label{fig:hi2lopincmass}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{figs/synth/hi2lo/hi2lo_pin_t}
    \caption{Single pin temperature distribution from synthetic TH data at 160\% nominal power conditions.}
    \label{fig:hi2lopint}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{figs/synth/hi2lo/hi2lo_pin_tke}
    \caption{Single pin surface TKE distribution from synthetic TH data at 160\% nominal power conditions.}
    \label{fig:hi2lopintke}
\end{figure}

\section{Single CTF Face Comparisons}
\begin{itemize}
    \item (\checkmark) Compare CTF vs Synthetic CFD vs Hi2Lo Reconstructed CRUD results on a single CTF face.
    \item (\checkmark) Show sensitivity of integrated crud mass and boron to the following tunable parameters.  Also show impact on uncertainty in these integrated results to:
    \begin{itemize}
        \item (\checkmark) The number of samples drawn per patch
        \item (\checkmark) Gaussian copula vs. best fit copula approach.
        \item (\checkmark) Number of quantiles used in the reconstruction of margins
    \end{itemize}
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.99\linewidth]{figs/synth/patch_scatter_0_4_0_6}
    \caption[Single patch synthetic CFD data vs hi2lo sampled data.]{Single patch synthetic data vs hi2lo sampled data from patch centered on the rod at (3.14 $[rad]$, 2.85 $[m]$) at 300$[days]$.}
    \label{fig:patchscatter}
\end{figure}

\subsubsection{Crud Copula Parameter Sensitivity}

Here the sensitivity of the crud result to the copula parameters is investigated.  Both the impact of the rank correlation coefficient and the archimidean copula family are investigated.  The sensitivity results from four patches are shown in figure ().  The result shows crud is relatively insensitive to the choice of copula, but the rank correlation coefficient can be an important quantity to accurately capture in the hi2lo model.  

Next, two full single pin scenarios were considered:  The first scenario uses the best-fit copula on each patch as determined by the AIC metric.  The second pin scenario enforces that a Gaussian copula model is used on every CTF face.  The crud results from these scenarios were then compared.  The data shows the choice of copula (between Gaussian, Frank, and Clayton) has a small overall impact on the total integrated rod boron mass.  A large simplification is possible.  The copula can be assumed to be Gaussian in all cases without significantly impacting overall integrated crud results.

\subsubsection{Crud Sample Size Study}

The number of samples used to estimate the integral in equation () is a user input.
As expected for a single rod the integrated crud variance is reduced by increasing the number of samples used per CTF face to estimate the integrated crud quantities of interest.   Section \ref{sec:Importance Sampling} demonstrates that improvements in sampling efficiency are possible by way of importance sampling.

\subsubsection{Crud Sensitivity to the Number of Quantiles}

The number of sample quantiles used in the reconstruction of the marginal distributions is a tunable input.  In this section the number of quantiles necissary to obtain a converged integrated crud estimate on a single rod is determined.  Only the case of evenly spaced probability levels is considered i.e the allowable probability levels used to compute the sample quantiles are evenly spaced in $[0, 1]$.   The results indicate that 20 sample quantiles results in a converged integrated and average axial crud solution.  


\subsubsection{Importance Sampling}
\label{sec:Importance Sampling}

To obtain estimates for the efficiency gain offered by importance sampling to compute \ref{eq:expected_crud}, a singe patch was studied under synthetic TH data.

The choice of importance distribution is informed by the crud response.  To compute the integral \ref{eq:expected_crud} efficiently it is favorable to sample the TH distribution in regions which result in crud and .  The importance distribution is shown in figure ().  

\begin{figure}[H]%
    \centering
    \subfloat[Crud boron deposition sensitivity to temperature with TKE held fixed at $0.05 J/kg$]{{\includegraphics[width=0.45\linewidth]{../proposal/slides/seminar_slides/figs/dboron_dt_t} }}%
    \qquad
    \subfloat[Crud boron deposition sensitivity to TKE with temperature held fixed at $620 K$]{{\includegraphics[width=0.45\linewidth]{../proposal/slides/seminar_slides/figs/dboron_dt_tke} }}%
    \caption[]{Crud marginal response to varying temperature and TKE.}%
    \label{fig:crud_sensi1}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[Crud boron deposition sensitivity with $q''=80 W/cm^2$.]{{\includegraphics[width=0.45\linewidth]{figs/crud/crud_t_tke_boron_response_80} }}%
    \qquad
    \subfloat[Crud boron deposition sensitivity $q''=120 W/cm^2$.]{{\includegraphics[width=0.45\linewidth]{figs/crud/crud_t_tke_boron_response_120} }}%
    \caption[]{Crud boron response to varying temperature and TKE.}%
    \label{fig:crud_sensi2}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[Crud mass deposition sensitivity$q''=80 W/cm^2$.]{{\includegraphics[width=0.45\linewidth]{figs/crud/crud_t_tke_mass_response_bhf_80} }}%
    \qquad
    \subfloat[Crud mass deposition sensitivity $q''=120 W/cm^2$.]{{\includegraphics[width=0.45\linewidth]{figs/crud/crud_t_tke_mass_response_bhf_120} }}%
    \caption[]{Crud mass response to varying temperature and TKE.}%
    \label{fig:crud_sensi3}%
\end{figure}


The optimal importance distribution depends on the crud response surface and the TH probability density function.  Though an unique optimal importance distribution can be theoretically found [ref], the minimization problems required are not solved in this work and are left as an avenue for future investigation.
Although the optimal importance distribution is forgone, a locally adaptive approach was pursued in this work based on a distribution mixing approach.  With a known crud TH response surface existing in only $R^3$ it is feasible to design a near-optimal importance distribution by hand.

\begin{equation}
Q(\tilde{p}) = \sum_i^m a_{qi} Q_i(\tilde{p})
\end{equation}
Where $Q_i$ are the quantile functions as $a_{qi}$ are the weights.

Beta distributions with proscribed parameters are used in mixture with the original density functions to produce a proposal density distribution for each patch.  The mixture weights may also be adjusted.  This approach yields extensive flexibility of proposal density for both the temperature and TKE marginal distributions.  Shown in figure \ref{fig:imp_sample2} the proposal


\begin{figure}[H]%
    \centering
    \subfloat[Crud boron deposition rate.]{{\includegraphics[width=0.45\linewidth]{figs/imp_patch/bmass_sample_violin} }}%
    \qquad
    \subfloat[Crud mass deposition rate.]{{\includegraphics[width=0.45\linewidth]{figs/imp_patch/cmass_sample_violin} }}%
    \caption[]{Importance sampling trial results.}%
    \label{fig:imp_sample1}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[Temperature distributions.]{{\includegraphics[width=0.45\linewidth]{figs/imp_patch/temperature_importance_marginal_compare} }}%
    \qquad
    \subfloat[TKE distributions.]{{\includegraphics[width=0.45\linewidth]{figs/imp_patch/tke_importance_marginal_compare} }}%
    \caption[]{Proposal vs. original marginal distributions.}%
    \label{fig:imp_sample2}%
\end{figure}

Although it is possible to specify a custom proposal copula density, for this work the original copula density distribution is adopted to construct the multivariate proposal density distribution.  This leads to the cancellation of the copula density in the computation of the importance weights.  With this assumption in place the sample weights can be computed efficiently using an independence assumption.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.99\linewidth]{figs/imp_patch/importance_t_tke_bmass_scatter}
    \caption[Importance sampled single patch crud result.]{Importance sampled single patch crud result.}
    \label{fig:importancettkebmassscatter}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.99\linewidth]{figs/imp_patch/original_t_tke_bmass_scatter}
    \caption[Standard Monte Carlo sampled patch crud result.]{Standard Monte Carlo sampled patch crud result.}
    \label{fig:originalttkebmassscatter}
\end{figure}

The importance sampling efficiency is estimated by computing the variance ratio:  $\frac{\sigma^2_{MC}}{\sigma^2_{I}}$.  For the case studied, the application of importance sampling reduced the crud mass and boron mass sample variance by a factor of 2.

The improvement in performance can be attributed to expending a larger proportion of sample in the upper tail of the temperature distribution as this is a region which strongly contributes to crud growth.


\subsection{Single Pin with Time Stepping}

\subsubsection{Spatial Remapping Results}
\begin{itemize}
	\item (\checkmark) Show influence of hot spot stationarity assumptions on crud growth.
\end{itemize}

\begin{itemize}
	\item (\checkmark) Show total integrated crud mass and crud boron as a function of time.
	\item (\checkmark) Show sensitivity of integrated crud mass and boron to the following.  Also show impact on uncertainty in these integrated results to:
	\begin{itemize}
		\item (\checkmark) Increase the number of samples drawn per patch.
		\item (\checkmark) Force Gaussian copula vs. best fit copula approach.
		\item (\checkmark) Increasing number of re-sampling time steps.
		We can re-sample from the joint $h(T, k, q'')$ distribution many times per TH state point.
		This reduces variance in the total integrated boron and crud mass quantities.
	\end{itemize}
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/synth/cmpr_pin_totals_0_4_0_6}
    \caption[Total integrated crud born mass vs. time using approximately optimal remapping weights.]{Total integrated crud born mass vs. time using approximately optimal remapping weights ($\alpha_T=0.4, \alpha_{k}=0.6, \alpha_{q''}=0.0$).}
    \label{fig:cmprpintotals0406}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/synth/cmpr_pin_totals_no_remap}
    \caption{Total integrated crud born mass vs. time without remapping samples.}
    \label{fig:cmprpintotalsnoremap}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/synth/patch_fields_0_4_0_6}
    \caption{}
    \label{fig:patchfields0406}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/synth/patch_fields_no_remap}
    \caption{}
    \label{fig:patchfieldsnoremap}
\end{figure}


Section Takeaways:
\begin{itemize}
	\item Increasing the number of samples per patch decreases variance in total crud and total precipitated boron estimates.
	\item Increasing the number of re-sampling steps per VERA state point reduces variance in the final integrated crud results.
    \item After drawing samples from the predicted TH distribution a reordering of the samples on the rod surface is necessary to preserve hot spot stationarity.  This is required for an optimal time marching sampling strategy.
    \item Importance sampling was shown to reduce the variance in the integrated crud results.
\end{itemize}
