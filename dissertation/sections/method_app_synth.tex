%! TEX root = ../dissertation_gurecky.tex

In this chapter marginal reconstruction from quantiles, copula fitting, Monte Carlo and importance sampling strategies are exercised with a synthetic data set.  Synthetic data offers advantages over CFD born data for the purposes of testing and evaluating the efficacy of the proposed models.  Since synthetic data conforms to a known form with specified distribution and bias parameters the fitting and sampling routines can be checked against the pre-specified expected result.
This chapter does not introduce machine learning components and does not explore forward model predictions.  See chapter \ref{sec:ml_cfd} for hi2lo model performance when used in a predictive capacity.

The availability of synthetic data alleviates the need to generate comparatively expensive CFD results to test the hi2lo strategy.  Some aspects of CFD fields are preserved in the synthetic ata, including expected biases between CFD and CTF results that arise due to discrepancies in wall heat transfer closure models, among other differences. Additionally turbulent dispersion of the temperature and surface shear distributions around spacer grids are emulated by the synthetic data model.  Accounting for spatial auto-correlation in the surface fields was not pursued.  Spatial autocorrelation present in the surface fields within a CTF face is not captured.  Consequently the synthetic data is not a direct replacement to CFD data but serves as data source for method interrogation and integration testing.

Semi-parametric copula and marginal distributions are fit to the synthetic data in each CTF face independently.  Samples are drawn from the fitted joint temperature, TKE and BHF density models on each patch using standard Monte Carlo methods or importance sampling.  The surface samples are provided to a crud simulation package as cladding-surface boundary conditions.  Additional required bulk coolant properties are supplied by CTF.
In this chapter some consequences of adopting a statistically based hi2lo map  on a multistate point, or time dependent crud simulation are discussed.

Finally, speedups afforded by importance sampling are presented.  The sampling distributions utilized in importance sampling are informed by the physics of crud growth.

\section{Generating Synthetic Data}

Synthetic data generation begins by first running standalone CTF on a single quarter symmetric pin and then augmenting the CTF result with tailored noise.  The augmented surface fields can be constructed by equation \ref{eq:synth_aug}.
\begin{align}
    \bm X &= \bm \mu_{ctf} + \bm b + \bm \varepsilon \nonumber \\
          &=
    \begin{pmatrix}
        T \\
        k \\
        q''
    \end{pmatrix}
    =
    \begin{pmatrix}
        \mu_{T} \\
        \mu_k \\
        \mu_{q''}
    \end{pmatrix}_{ctf}
    + \begin{pmatrix}
        b_{T} \\
        b_k \\
        b_{q''}
    \end{pmatrix}
    + \bm{\varepsilon} (\mathbf z; \bm \theta),
\label{eq:synth_aug}
\end{align}
Where $\bm \varepsilon(\mathbf z, \bm \theta)$ is a user controlled spatially dependent residual random vector with a mean of 0.  This residual is
shifted by a bias vector
$\mathbf b$, where $\mathbf z=\{z, \varphi\}$ is the axial and azimuthal location on the rod surface.
$\bm \theta$ represents user specified distribution parameters.

Equation \ref{eq:synth_aug} represents three continuous random surface fields.  In practice a large number of independent and identically distributed samples are drawn in each CTF face from the underlaying random field.  Individual surface samples can be specified by equation \ref{eq:synth_aug_discrete}.

\begin{equation}
    X_{ij} = \mu_{j,\ ctf} + b_j + \varepsilon_{ij};\ \   \varepsilon_{ij} \sim h_j
    \label{eq:synth_aug_discrete}
\end{equation}
Where the index $j$ represents the $j^{th}$ CTF face on the rod, and the index $i$ is the sample index within the $j^{th}$ CTF face.  The distribution parameters are constant over a given CTF face and give by $\bm \theta = \{\theta_c, \{\theta_x\}\}$ where $\theta_c$ is the copula parameter and  $\{\theta_x\}$ are marginal parameters, 


Shown in equation \ref{eq:synth_aug_face}, according to Sklar's theorem the surface residual temperature and TKE joint distribution may be decomposed into copula an marginal models on each CTF face:

\begin{equation}
    h_j = c_j(F_k(k), F_T(T); \theta_{c_j}) f_{T}(T; \theta_{T_j}) f_{k}(k; \theta_{k_j})
    \label{eq:synth_aug_face}
\end{equation}
Where the copula parameter $\theta_{c_j}$ and the marginal temperature and TKE distribution parameters $\theta_{T_j}$ and $\theta_{k_j}$ are set at runtime of the synthetic data generation tool.

To allow for a great deal of flexibility in the synthetic data the copula family, Kendall's $\tau$ rank correlation coefficient and marginal distribution parameters are specified as a function of axial location and local TH conditions supplied by CTF.  The copula's shape parameter, $\theta_c$ may be related to the rank correlation coefficient by equation \ref{eq:tauar} which is a one to one function for the Archimidean copula considered in this work.


\subsection{Single Pin Synthetic Data Set}

The original baseline CTF results are shown in figures \ref{fig:ctf_twall_orig} and \ref{fig:ctf_tke_orig}.  The CTF pin parameters are provided in table \ref{tab:pin_settings}.  The CTF result was produced from a quarter symmetric case, and therefore no azimuthal variation is observed.

\begin{table}[h]
    \begin{center}
        \caption{Single pin reference thermal hydraulic boundary conditions.}
        \begin{tabular}{|l|l|l|}
            \hline
            Setting & Value & Unit \\
            \hline
            Inlet Flow Rate & 0.3 & $[kg/s]$ \\
            Inlet Temperature & 565 & $[K]$ \\
            Pressure & 2250 & $[psia]$ \\
            Rod Outer Radius & 0.425 & $[cm]$ \\
            Pin Pitch & 1.26 & $[cm]$ \\
            Power Shape & constant & $[]$ \\
            Heat Flux & 85.86  & $[W/m^2]$ \\
            Rod Height & 3.6275 & $[m]$ \\
            Number of Grids & 3  & $[]$ \\
            Grid Locations & 2.0, 2.4, 2.8 & $[m]$ \\
            \hline
        \end{tabular}
    \label{tab:pin_settings}
    \end{center}
\end{table}

\begin{figure}[H]%
    \centering
    \subfloat[Axial CTF cladding surface temperature result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/ctf_asm0_z_twall} }}%
    \qquad
    \subfloat[2D rod map of CTF result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/ctf_pin_h5_temperature} }}%
    \caption[Single pin CTF baseline temperature result.  160\% nominal power conditions.]{Single pin CTF baseline temperature result.  160\% nominal power conditions.}%
    \label{fig:ctf_twall_orig}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[Axial CTF cladding surface TKE result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/ctf_asm0_z_tke} }}%
    \qquad
    \subfloat[2D rod map of CTF result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/ctf_pin_h5_tke} }}%
    \caption[Single pin CTF baseline TKE result.  160\% nominal power conditions.]{Single pin CTF baseline TKE result.  160\% nominal power conditions.}%
    \label{fig:ctf_tke_orig}%
\end{figure}


The boundary heat flux was uniform at $85.86 [W/cm^2]$ which corresponds to approximately 160\% nominal PWR power conditions.

Next synthetic noise was generated using copula and marginal disrubution settings provided in table \ref{tab:synth_settings}. The complete synthetic data generation input deck for this case along with references to the code are provided in Appendix ().

\begin{table}[h]
    \begin{center}
        \caption{Per-span synthetic data generation settings.}
        \begin{tabular}{|l|l|l|l|l|}
            \hline
            \bf Span 1 & Node & Node location & Copula Settings  & Margin Settings \\
            \hline
            $N$: 8000  & 1  & 0.0 & $\Theta_c:$ Gaussian, $\theta_c:-0.6$ &  T:$\beta(5.0, 5.0)$ , k: $\mathcal{N}(0, 0.001)$ \\
                   & 2  & 2.0 & $\Theta_c:$ Gaussian, $\theta_c:-0.6$ &  T:$\beta(5.0, 5.0)$ , k: $\mathcal{N}(0, 0.001)$   \\
            \hline \hline
            \bf Span 2 & Node & Node location & Copula Settings  & Margin Settings \\
            \hline
             $N$: 8000 & 1  & 2.0 & $\Theta_c:$ Clayton-90, $\theta_c: 2.0$ &  T:$\beta(5.0, 2.7)$ , k: $\beta(1.75, 5.0)$ \\
            & 2  & 2.4 & $\Theta_c:$ Frank-90, $\theta_c: 8.0$ &  T:$\beta(5.0, 1.5)$ , k: $\beta(1.75, 5.0)$   \\
            \hline \hline
            \bf Span 3 & Node & Node location & Copula Settings  & Margin Settings \\
            \hline
             $N$: 8000 & 1  & 2.4 & $\Theta_c:$ Clayton-90, $\theta_c: 2.0$ &  T:$\beta(5.0, 2.7)$ , k: $\beta(1.75, 5.0)$ \\
            & 2  & 2.8 & $\Theta_c:$ Frank-90, $\theta_c: 8.0$ &  T:$\beta(5.0, 1.5)$ , k: $\beta(1.75, 5.0)$   \\
            \hline \hline
            \bf Span 4 & Node & Node location & Copula Settings  & Margin Settings \\
            \hline
            $N$: 8000 & 1  & 2.8 & $\Theta_c:$ Clayton-90, $\theta_c: 2.0$ &  T:$\beta(5.0, 2.7)$ , k: $\beta(1.75, 5.0)$ \\
            & 2  & 3.6 & $\Theta_c:$ Frank-90, $\theta_c: 8.0$ &  T:$\beta(5.0, 1.5)$ , k: $\beta(1.75, 5.0)$   \\
            \hline
        \end{tabular}
        \label{tab:synth_settings}
    \end{center}
\end{table}

Samples are drawn with probability proportional to the inverse distance to the nearest specified node.
Let the subscript $_u$ denote the location of the upstream span and $_d$ denote the downstream grid. $d_{u_j}$ and  $d_{d_j}$ denote the distance from the centroid of the CTF face to the nearest upsteam and downstream copula nodes respectively.

The mixture joint density model in any given CTF face can be specified by equation \ref{eq:dist_weighted_synth}.
\begin{equation}
    h_j = \left( \frac{d_{u_j}}{|d_{d} - d_{u}|} \right) h_u +
    \left( \frac{d_{d_j}}{|d_{d} - d_{u}|} \right) h_d
    \label{eq:dist_weighted_synth}
\end{equation}
For simplicity, two copula nodes were specified per span though more are possible for a finer grained control over the marginal and copula distributions.  The copula node properties are given in table \ref{tab:synth_settings}.  The copula nodes were located at the span extrema. This node specification pattern allows the synthetic data to mimic the expected sharp change in copula and marginal distributions when moving across spacer grids as seen in the raw CFD data presented in chapter () in figures () and ().

The copula models were sampled in each span, the original CTF result was augmented with the synthetically generated noise in accordance with equation \ref{eq:synth_aug_discrete}.

\begin{figure}[H]%
    \centering
    \subfloat[Spatial axial augmented CTF result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/pinH5TempOut} }}%
    \qquad
    \subfloat[2D rod map of sythetically augmented CTF result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/cfd_pin_temperature} }}%
    \caption[Augmented CFD result.]{Augmented CTF temperature result.}%
    \label{fig:ctf_twall_aug}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[Spatial axial augmented CTF result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/pinH5TkeOut} }}%
    \qquad
    \subfloat[2D rod map of sythetically augmented CTF result.]{{\includegraphics[width=0.45\linewidth]{figs/synth/cfd_pin_tke} }}%
    \caption[Augmented CFD TKE result.]{Augmented CTF TKE result.}%
    \label{fig:ctf_tke_aug}%
\end{figure}

The augmented surface temperature and turbulent kinetic energy fields shown if figures \ref{fig:ctf_twall_aug} and \ref{fig:ctf_tke_aug} can be compared against the original CTF results provided in figures \ref{fig:ctf_twall_orig} and \ref{fig:ctf_tke_orig} respectively.  No azimuthal variations are present in the augmented fields which would be present if a physics based model, such as CFD, were used.  Additionally, no spatial auto-correlation in the temperature and TKE cladding surface fields are included in the synthetic data.  Spatial autocorrelation could be captured with a kriging model in the future, however, the one dimensional nature of the crud simulation code used in this work dictates that the fine scale spatial detail in the surface fields are irrelevant when computing surface-integrated crud quantities.


\subsection{Single Pin Reconstruction}

The rod surface is subdivided into CTF faces before fitting and reconstructing the synthetic data.  The location and extent of the CTF faces on the rod surface can be determined from a CTF output file.  

In each face the empirical quantile distribution of temperature, turbulent kinetic energy, and boundary heat flux distributions are computed.  The number and spacing of quantiles used in the empirical quantile distribution is user specified.  Copula are fit to the synthetic data based on maximum likelihood and the Akaike information criterion (AIC) in each CTF face.  Maximum likelihood estimation is described in section \ref{sec:fitting_copula} and the AIC may be computed from equation \ref{eq:cop_aic}.

For the synthetic single pin data the hi2lo predicted fractional surface area above a saturation temperature threshold ($T_{sat}$) is shown in figure \ref{fig:frac_a}.

\begin{figure}[H]%
    \centering
    \subfloat[CTF predicted fractional area of each CTF face above the saturation point.]{{\includegraphics[width=0.45\linewidth]{figs/synth/hi2lo/ctf_pin_t_threshold} }}%
    \qquad
    \subfloat[Hi2lo predicted fractional area of each CTF face above the saturation point.]{{\includegraphics[width=0.45\linewidth]{figs/synth/hi2lo/hi2lo_pin_t_threshold} }}%
    \caption[]{Fraction area above the saturation point prediction comparison for the synthetic data set.}%
    \label{fig:frac_a}%
\end{figure}

Provided that crud growth exhibits a temperature thresholding behavior about the saturation point it is important to predict the fractional area of the rod surface which exists above this critical temperature. Figure \ref{fig:frac_a} shows a substantial difference in the fractional area predicted above the saturation point in each CTF face when utilizing the hi2lo model rather than the predictions generated from a CTF computation alone.  The more significant the thresholding behavior of crud growth, the more important it becomes to accurately compute areas of the rod surface in excess of the saturation point.

Figure \ref{fig:patchscatter} examines the surface frequency distributions of temperature, crud boron mass and TKE for the CTF patch denoted by the red box in figures \ref{fig:hi2lopincmass} and \ref{fig:hi2lopintke}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.99\linewidth]{figs/synth/patch_scatter_0_4_0_6}
    \caption[Single patch synthetic CFD data vs hi2lo sampled data.]{Single patch synthetic data vs hi2lo sampled data from patch centered on the rod at (3.14 $[rad]$, 2.85 $[m]$) at 300$[days]$.}
    \label{fig:patchscatter}
\end{figure}

After samples are independently drawn in each CTF face the temperature, TKE, and boundary heat flux samples were passed to a crud simulation packages as aboundary condtitions.  The crud simulation was stepped forward for 300 days with a resample step size of 50 days.  The resultant crud distribution is given in figure \ref{fig:hi2lopincmass}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{figs/synth/hi2lo/hi2lo_pin_cmass}
    \caption[Single pin crud mass distribution from synthetic TH data.]{Single pin crud mass distribution from synthetic TH data at 160\% nominal power conditions at 300 days simulation time.}
    \label{fig:hi2lopincmass}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{figs/synth/hi2lo/hi2lo_pin_t}
    \caption{Single pin temperature distribution from synthetic TH data at 160\% nominal power conditions at 300 days.}
    \label{fig:hi2lopint}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{figs/synth/hi2lo/hi2lo_pin_tke}
    \caption{Single pin surface TKE distribution from synthetic TH data at 160\% nominal power conditions at 300 days.}
    \label{fig:hi2lopintke}
\end{figure}

% \begin{figure}[H]%
%     \centering
%     \subfloat[Hi2lo patch cladding wall temperature spatial distrubtion]{{\includegraphics[width=0.45\linewidth]{figs/synth/hi2lo/hi2lo_patch_t} }}%
%     \qquad
%     \subfloat[Hi2lo patch TKE spatial distrubtion.]{{\includegraphics[width=0.45\linewidth]{figs/synth/hi2lo/hi2lo_patch_tke} }}%
%     \caption[]{Single hi2lo patch sample reordering demonstration.}%
%     \label{fig:reshuffle_a}%
% \end{figure}

\subsubsection{Crud Copula Parameter Sensitivity}
\label{sec:crud_copula_sensi}

Here the sensitivity of the crud result to the copula parameters is investigated.  Both the impact of the rank correlation coefficient, Kendall's $\tau$, and the Archimidean copula family are investigated.  The sensitivity results generated for the patch centered at $(\theta=3.14[rad], z=2.95[m])$ are shown in figure \ref{fig:patchcrudfit80}.  There is noise present in the crud predictions due to the Monte Carlo integration of equation \ref{eq:expected_crud} over the patch.  In this instance 2500 samples were used.  The crud is relatively insensitive to the choice of copula family, but the rank correlation coefficient is shown to have a significant influence on crud growth with an average boron deposition sensitivity of $\frac{\partial C_b}{\partial \rho_\tau} =$ -1.086e-7 $[g/cm^2/\tau]$ for this particular patch.  Accurately predicting Kendall's $\tau$ provided local core conditions is important.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/synth/patch_crud_fit_80}
    \caption{Single CTF face crud sensitivity to copula parameters.}
    \label{fig:patchcrudfit80}
\end{figure}

Next, two full single pin scenarios were considered. In the first scenario, shown if figure \ref{fig:crud_copula_fam_sensi}a, the best-fit copula on each patch as determined by the AIC metric is applied on each CTF face.  The second pin scenario enforces that a Gaussian copula model is used on every CTF face.  The crud results from these scenarios were then compared.  The data shows the choice of copula (between Gaussian, Frank, and Clayton) has a small overall impact on the total integrated rod boron mass.   The total integrated crud mass and crud boron mass for these scenarios at 300 days simulation time are given in table \ref{tab:crud_totals_copula}.

\begin{figure}[H]%
    \centering
    \subfloat[Best fit copula via AIC metric used in each CTF face.]{{\includegraphics[width=0.45\linewidth]{figs/synth/copula_compare/struct_pin_z_cmass_300_bestfit} }}%
    \qquad
    \subfloat[Gaussian copula used in each CTF face.]{{\includegraphics[width=0.45\linewidth]{figs/synth/copula_compare/struct_pin_z_cmass_300_gauss_only} }}%
    \caption[]{Influence of the choice parameters on the axial crud distribution.}%
    \label{fig:crud_copula_fam_sensi}%
\end{figure}


\begin{table}[h]
    \begin{center}
        \caption[Crud totals with different copula assumptions.]{Single pin crud totals at 300 days with different copula assumptions.}
        \begin{tabular}[h]{|l | l | l |}
            \hline
            Copula, $\Theta_c$ & Crud Boron Total: $C_B$ & Crud Mass Total: $C_m$ \\
            \hline  \hline
            Best Fit &  2.78953e-04 $[g]$ & 5.34015e-01 $[g]$ \\
            Gaussian &  2.78301e-04 $[g]$ & 5.32769e-01 $[g]$ \\
            \hline
            Rel Diff &  0.01724 $[\%]$ & 0.23396 $[\%]$ \\
            \hline
        \end{tabular}
        \label{tab:crud_totals_copula}
    \end{center}
\end{table}

The choice of the copula family, $\Theta_c$, has a negligible impact on the integrated crud results over a pin.  This result can reduce the complexity of the hi2lo model by removing the need to predict the correct copula family on each CTF patch in the core.  In section (), it is shown that CFD data exhibits a complex relationship between the best fitting copula family and the axial position along the rod.  This relationship is difficult to model using standard classification techniques, though further testing with a larger quantity of training data is warranted to ascertain if the copula family describing the dependence between the temperature and TKE fields on the rod surface can be accurately predicted given local core conditions.

\subsubsection{Crud Sample Size Study}

The number of samples, $N$, used to estimate the integral given in equation \ref{eq:expected_crud} is a parameter set at runtime of the hi2lo method.
As expected for a single rod the integrated crud variance is reduced by increasing the number of samples used per CTF face to estimate the integrated crud quantities of interest.   Section \ref{sec:Importance Sampling} demonstrates that improvements in sampling efficiency are possible by way of importance sampling.

Figure \ref{fig:cmprpintotalsviolinnsample} shows that increasing the number of samples used to in crud expected value Monte Carlo approximation yields an improvement in the variance of the predicted integrated crud results.  A single 300 day time step was conducted without re-sampling the underlaying density functions during this period.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/synth/nsample_study/cmpr_pin_totals_violin_nsample}
    \caption{Effect of sample size on the integrated crud results.}
    \label{fig:cmprpintotalsviolinnsample}
\end{figure}



\subsubsection{Importance Sampling}
\label{sec:Importance Sampling}

To obtain estimates for the efficiency gain offered by importance sampling to compute the integral shown in equation \ref{eq:expected_crud}, a singe patch was studied under synthetic TH data.

The choice of importance distribution is informed by the crud response.  To compute the integral \ref{eq:expected_crud} efficiently it is favorable to sample the TH distribution in regions which result in relatively large amounts of crud growth.  The response surface of the crud simulation code is presented in figures \ref{fig:crud_sensi1} to \ref{fig:crud_sensi3}.  Larger surface temperatures result in a higher crud growth rate.  Larger local TKE results in smaller crud growth rates due to the effects of erosion.  Additionally of note is the relatively small influence of the boundary heat flux.

\begin{figure}[H]%
    \centering
    \subfloat[Crud boron deposition sensitivity to temperature with TKE held fixed at $0.05 J/kg$]{{\includegraphics[width=0.45\linewidth]{../proposal/slides/seminar_slides/figs/dboron_dt_t} }}%
    \qquad
    \subfloat[Crud boron deposition sensitivity to TKE with temperature held fixed at $620 K$]{{\includegraphics[width=0.45\linewidth]{../proposal/slides/seminar_slides/figs/dboron_dt_tke} }}%
    \caption[]{Crud marginal response to varying temperature and TKE.}%
    \label{fig:crud_sensi1}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[Crud boron deposition sensitivity with $q''=80 W/cm^2$.]{{\includegraphics[width=0.45\linewidth]{figs/crud/crud_t_tke_boron_response_80} }}%
    \qquad
    \subfloat[Crud boron deposition sensitivity $q''=120 W/cm^2$.]{{\includegraphics[width=0.45\linewidth]{figs/crud/crud_t_tke_boron_response_120} }}%
    \caption[]{Crud boron response to varying temperature and TKE.}%
    \label{fig:crud_sensi2}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[Crud mass deposition sensitivity$q''=80 W/cm^2$.]{{\includegraphics[width=0.45\linewidth]{figs/crud/crud_t_tke_mass_response_bhf_80} }}%
    \qquad
    \subfloat[Crud mass deposition sensitivity $q''=120 W/cm^2$.]{{\includegraphics[width=0.45\linewidth]{figs/crud/crud_t_tke_mass_response_bhf_120} }}%
    \caption[]{Crud mass response to varying temperature and TKE.}%
    \label{fig:crud_sensi3}%
\end{figure}


The optimal importance distribution depends on the crud response surface and the TH probability density function.  Though an optimal importance distribution can be found [ref], the minimization problem is not solved in this work and is left as an avenue for future investigation.
Although the theoretically optimal importance distribution is not achieved in this work, a locally adaptive importance function was adopted based on a distribution mixing approach.  The importance distribution can be made to depend on the temperature and TKE marginal distributions in a particular CTF face.  The temperature and TKE distributions in each CTF face are mixed with a beta distribution who's parameters are set at runtime of the hi2lo tool.  

\begin{equation}
Q(\tilde{p}) = \sum_i^m a_{qi} Q_i(\tilde{p})
\end{equation}
Where $Q_i$ are the quantile functions as $a_{qi}$ are the weights.

Beta distributions with proscribed parameters are used in mixture with the original temperature and TKE density functions to produce a proposal density distribution for each patch.  The mixture weights can be adjusted.  This approach yields flexibility in the design of proposal density and by suitably tuning the parameters of the beta distributions.  Shown in figure \ref{fig:imp_sample2}, the sampling distribution can be skewed towards higher temperatures and lower TKE.

\begin{figure}[H]%
    \centering
    \subfloat[Temperature distributions.]{{\includegraphics[width=0.45\linewidth]{figs/imp_patch/temperature_importance_marginal_compare} }}%
    \qquad
    \subfloat[TKE distributions.]{{\includegraphics[width=0.45\linewidth]{figs/imp_patch/tke_importance_marginal_compare} }}%
    \caption[]{Proposal vs. original marginal distributions.}%
    \label{fig:imp_sample2}%
\end{figure}


\begin{figure}[H]%
    \centering
    \subfloat[Crud boron deposition rate.]{{\includegraphics[width=0.45\linewidth]{figs/imp_patch/bmass_sample_violin} }}%
    \qquad
    \subfloat[Crud mass deposition rate.]{{\includegraphics[width=0.45\linewidth]{figs/imp_patch/cmass_sample_violin} }}%
    \caption[]{Importance sampling trial results on a single CTF face.}%
    \label{fig:imp_sample1}%
\end{figure}

In figures \ref{fig:importancettkebmassscatter} the relative importance weight is denoted by the size of each point in the scatter plot.  Samples which have a small ratio $(h_i/\tilde h_i)$ appear as small points.  The sample weight is analogous to the rod surface area occupied by the sample.  In comparison, figure \ref{fig:originalttkebmassscatter} shows the same patch using a standard Monte Carlo sampling where each sample has the same weight.  The number of samples drawn in the upper tail of the temperature distribution is greater when importance sampling is applied, though these samples carry expectedly small sample weights.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.99\linewidth]{figs/imp_patch/importance_t_tke_bmass_scatter}
    \caption[Importance sampled single patch crud result.]{Importance sampled single patch crud result.}
    \label{fig:importancettkebmassscatter}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.99\linewidth]{figs/imp_patch/original_t_tke_bmass_scatter}
    \caption[Standard Monte Carlo sampled patch crud result.]{Standard Monte Carlo sampled patch crud result.}
    \label{fig:originalttkebmassscatter}
\end{figure}

The importance sampling efficiency can be estimated by computing the variance ratio:  $\frac{\sigma^2_{MC}}{\sigma^2_{I}}$.  The variance of the patch-integrated crud result for the Monte Carlo and importance sampling schemes are provided figure \ref{fig:imp_sample1}.  The variance estimates were performed by running 1000 independent trials in which crud was grown on the patch for 300 days.  A total of 100 samples per patch per trial were used.  For the case studied, the application of importance sampling reduced the crud mass and boron mass sample variance by a factor of 2.02 $\approx$ [ (4.979e-6)$^2$ / (3.503e-6)$^2$].  The mean crud predictions did not significantly deviate between two sampling schemes indicating that importance sampling does not introduce any bias in the evaluation of the integral in equation \ref{eq:expected_crud}.

The improvement in performance afforded by importance sampling can be attributed to expending a larger proportion of the total available samples in the upper tail of the temperature distribution as this is a region which strongly contributes to crud growth.  Some samples necessarily expended in cold regions of the rod surface but occur with less frequency when compared to a standard Monte Carlo sampling routine and the samples are appropriately weighted to avoid biasing the integrated result.


\subsection{Single Pin with Time Stepping}

Stepping the crud simulation forward under the application of hi2lo supplied boundary conditions demands careful treatment of hot spot stationarity assumptions.  The time evolution of the crud simulation on the rod surface is strongly influenced by choices made both in the number of re-sampling steps taken as well as tunable constants which govern the sample remapping procedure and surface temperature mixing.

\subsubsection{Spatial Remapping with Time Stepping}

The influence of hot-spot stationarity assumptions on the overall integrated crud mass on the rod as a function of time can be seen in figures \ref{fig:cmprpintotals0406} and \ref{fig:cmprpintotalsnoremap}.  When the surface temperature is allowed to randomly mix on each re-sampling event in each CTF face, the influence of the hot spots are smeared over the surface of the rod which leads to an overall under prediction in the total integrated crud mass.  Reordering the samples in each CTF face by their temperature improves the ability of the hi2lo model to preserve the impact of stationary hot and cold spots on the rod surface.  Good agreement with the original coupled synthetic CFD-Crud simulation data was achieved by tuning the constants introduced in equation \ref{eq:weighting} to values of $\omega_T = 0.4$, and of $\omega_k = 0.6$.  This weighting seeks to preserve a heuristic thermal-hydraulic metric on the rod surface  where the metric can be interpreted as some linear combination of cladding surface temperature and near-wall TKE. 


\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/synth/cmpr_pin_totals_0_4_0_6}
    \caption[Total integrated crud born mass vs. time using approximately optimal remapping weights.]{Total integrated crud born mass vs. time using approximately optimal remapping weights ($\omega_T=0.4, \omega_{k}=0.6, \omega_{q''}=0.0$).}
    \label{fig:cmprpintotals0406}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/synth/cmpr_pin_totals_no_remap}
    \caption{Total integrated crud born mass vs. time without remapping samples.}
    \label{fig:cmprpintotalsnoremap}
\end{figure}

A spatial representation of the samples pre and post-remapping are shown in figure \ref{fig:remmap_comp}.  A visual representation of the remapping strategy presented is presented in figure \ref{fig:samplemapping}.

\begin{figure}[H]%
    \centering
    \subfloat[Remapped surface samples.]{{\includegraphics[width=0.45\linewidth]{figs/synth/patch_fields_0_4_0_6} }}%
    \qquad
    \subfloat[Non-remapped surface samples]{{\includegraphics[width=0.45\linewidth]{figs/synth/patch_fields_no_remap} }}%
    \caption[Re-mapped and non remaped temperature and TKE surface samples]{Re-mapped (a) and non remaped (b) temperature and TKE surface samples for a single CTF face.}%
    \label{fig:remmap_comp}%
\end{figure}

\subsection{Re-Sample Frequency}
\label{sec:resample_freq_study}

The frequency at which the distribution functions are sampled from on each CTF face influences the variance in the predicted integrated crud results.  To investigate this behavior, a parameter sweep was conducted in which the same pin was.  50 independent trials were conducted for each step size shown if table ().  Shown in figure \ref{fig:cmprpintotalsviolin} a smaller re-sampling steps size, $\Delta t_s$, results in a reduction in the variance of the rod integrated crud estimates at 300 days of simulation time.  It is also important to note that the variance of the rod integrated crud results increases as a function of time.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/synth/tstep_study/cmpr_pin_totals_violin}
    \caption{Influence of the re-sample frequency on the predicted integrated crud variance.}
    \label{fig:cmprpintotalsviolin}
\end{figure}

Performing a larger number of re-sampling events per VERA state results in reduced variance at little additional computational effort.
This is in part due to the minimal computational requirements of sampling the joint temperature and TKE distribution on each patch.  Drawing samples from a bivariate copula density model is straight forward, as indicated in equation (), and can be done in parallel since each patch is treated as an independent sampling zone in this hi2lo approach.  The crud computation, by comparison, is more expensive.  Increasing the re-sampling frequency does not increase the total number of samples used per pin per time step, rather, this process only increases the number of (re-sample) steps per VERA state point.  The reduction in variance stems from an improved sample density throughout time of the underlying random field.  In time, the underlaying random field is fixed throughout a VERA state point.  Repeatedly drawing samples from this field at small time steps rather than sampling the random field only once at the beginning of the VERA state point vastly increases the number of samples used to perform the time integration of the crud result on each CTF face.


\subsection{Section Takeaways}
\begin{itemize}
        \item Table () and figure () show good rod-integrated crud agreement between the synthetic source data and the predicted results.  Fitting copula and marginal distributions to the sample data, re-sampling from these models, and then growing curd using these samples reproduces the correct total amount of crud at each time step and correctly reproduces the axial distribution of crud as shown in figure ().
        \item Increasing the number of samples per patch decreases variance in total crud and total precipitated boron estimates.
        \item Increasing the number of re-sampling steps per VERA state point reduces variance in the final integrated crud results.
        \item After drawing samples from the predicted TH distribution a reordering of the samples on the rod surface is necessary to preserve hot spot stationarity.  This is required for an optimal time marching sampling strategy.
        \item Importance sampling was shown to reduce the variance in the integrated crud results.
        \item A synthetic data generation tool allows absolute control over the properties of joint distribution of TH boundary conditions which are fed into the crud simulation code.  Since the synthetic data has known properties, this data serves as an important data source for benchmarking and validation operations.
\end{itemize}
