%! TEX root = ../dissertation_gurecky.tex

\section{Machine Learning Model Trained on CFD Data Source}

\begin{itemize}
	\item (\checkmark-) Harvesting CFD data for training. Explain the pre-processing pipeline.
	\item ($\cdot$) Why use gradient boosted regression trees vs some other ML technique?
\end{itemize}

\subsection{Preprocessing}
For each pin in the dataset, the 
\begin{figure}[H]%
    \centering
    \subfloat[Pin 1]{{\includegraphics[width=0.45\linewidth]{figs/preproc/copula_params_pin_1} }}%
    \qquad
    \subfloat[Pin 2]{{\includegraphics[width=0.45\linewidth]{figs/preproc/copula_params_pin_2} }}%
    \qquad
        \subfloat[Pin 3]{{\includegraphics[width=0.45\linewidth]{figs/preproc/copula_params_pin_3} }}%
    \qquad
        \subfloat[Pin 4]{{\includegraphics[width=0.45\linewidth]{figs/preproc/copula_params_pin_4} }}%
    \qquad
    \caption[Best fitting copula to CFD data.]{Best fitting copula class as determined by the AIC as a function of axial rod position.}%
    \label{fig:tkepin1}%
\end{figure}


\subsection{Feature Engineering}

The first objective of feature engineering is to select a predictive variable set that can describe the behavior of the conditional quantiles and copula everywhere in the assembly.
   
\begin{table}[h]
    \begin{center}
    \caption[Included features.]{Features included in the gradient boosted models.}
\begin{tabular}[h]{|l | l | l |}
    \hline
    Symbol & Feature & Unit \\
    \hline
    $T$ & Bulk Temperature  &  $[K]$ \\
    $q''$ & Local heat flux & $[W/m^2]$ \\
    $u_z$ & Bulk Z Velocity &  $[m/s]$ \\
    $k$ & Near wall TKE &  $[J/kg]$ \\
    $z$ & Absolute axial position & $[m]$ \\
    $z_g$ & Position relative to Nearest Spacer Grid & $[m]$ \\
    $N_g$ & Nearest upstream spacer grid ID & $[]$ \\
    \hline
\end{tabular}
\label{tab:features}
\end{center}
\end{table}

The predictive variables given in table \ref{tab:features} were selected based on two criteria:  availability and orthogonality.  A predictive variable must be made available by VERA or must be computable from CTF results alone.  This must be true since when evaluating the hi2lo model, the inputs to the hi2lo model must come from either previously stored information or information made available by CTF at runtime.  At this juncture, this criteria precludes using information such as geometric orientation of a given spacer grid since it is not possible to extract or infer this information from the CTF output.

It is not useful to include multiple variables which are co-linear therefore the bulk fluid density was not included in the predictive variable set as it only strongly depends on the local temperature in PWR. Likewise the local static pressure was not used as a predictive variable.  The exclusion of this TH information is primarily done for computational saving when training the boosted models.  

It should be noted that gradient boosting is particularly resilient to co-linear variables in the feature set.  Their inclusion will not necessarily reduce the model's ability to generalize to unseen data, only hamper computational efficiency.  The resulting feature importance plot shown in figure \ref{fig:ktauregfeatureimp} suggests that the relative axial position within a span does not provide predictive power since this information is redundant provided the absolute axial position and the nearest upstream spacer grid.  

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/ktau_reg_feature_imp}
    \caption[Relative feature importance.]{Relative feature importances on kendall's $\tau$.}
    \label{fig:ktauregfeatureimp}
\end{figure}

\begin{itemize}
	\item ($\cdot$) Is an edge pin special?  Can we predict the impact of neighboring
	guide tubes on the crud growth rate?  (Maybe move to future work.)
	\item ($\cdot$) Perform principle component analysis on the remaining predictive variables. (Maybe move to future work.)
	
\end{itemize}


\subsection{Cross Validation}

An estimate of the interpolation error incurred when evaluating the trained models at unknown CFD states can be made by performing a leave one out (LOO) cross validation study.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.3\linewidth]{figs/drawings/5x5_loo}
    \caption[Example pin layout for leave-one-out cross validation procedure.]{Example pin layout for leave-one-out cross validation procedure.  The gradient boosted models are trained on CFD and CTF data extracted from the blue pins.  Crud predictions are made on the missing pin.}
    \label{fig:5x5loo}
\end{figure}


As depicted in figure \ref{fig:5x5loo}, in this procedure a single CFD/CTF pin pair is removed from the database and then the model is retrained on remaining data.  Following this retraining, a crud prediction is made 
at the missing pin's TH conditions.  The crud results are compared against crud results generated using the full training data set.  This process is repeated by sequentially for each pin in the 5x5 set.  The differences are summarized and averaged to obtain a measure of model's predictive performance when applied to TH conditions that reside in the TH training envelope.

This cross validation technique only ascertains interpolation errors within the TH envelope enclosed by the original full training set.  The resulting interpolation error estimates cannot be extrapolated to core conditions that lay outside of the training set.  For a robust interpolation error analysis, a much larger training data set is required
that spans essentially all possible TH conditions encountered in an operational PWR.  This will require large scale CFD runs and is left as a avenue for future uncertainty quantification work.

\subsection{Quantile Regressors}

\begin{itemize}   
    \item (\xmark) \sout{Compute quantile uncertainty estimates associated with predicted quantiles provided by the trained ML model} (Unsure if feasible.  Look at BART ensemble of trees method. Future work)
    \item (\xmark) \sout{Propagate ML model-induced quantile uncertainties} (Future work)
\end{itemize}


Q-Q plots of the  temperature and TKE residual distributions are used to elucidate bias introduced by the machine learning model at a variety of axial positions and local core conditions.  The results are computed by evaluating the model given boundary conditions from the left-out pin and comparing to the expected CFD result.
A subset of the TKE residual quantile regression results are given in figure \ref{fig:tkepin1} to \ref{fig:tkepin3}.

\begin{figure}[H]%
    \centering
    \subfloat[TKE quantile regression results. CFD in solid line.  Predicted values as dashed.]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/q_tke_regression_1} }}%
    \qquad
    \subfloat[Q-Q plot of TKE quantile regression predictions from LOO cross validation study]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/qq_tke_pin_1} }}%
    \caption[Q-Q LOO TKE pin 1 results.]{Pin 1 TKE quantile regression predictions from LOO cross validation study.}%
    \label{fig:tkepin1}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[TKE quantile regression results. CFD in solid line.  Predicted values as dashed.]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/q_tke_regression_2} }}%
    \qquad
    \subfloat[Q-Q plot of TKE quantile regression predictions from LOO cross validation study]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/qq_tke_pin_2} }}%
    \caption[Q-Q LOO TKE pin 2 results.]{Pin 1 TKE quantile regression predictions from LOO cross validation study.}%
    \label{fig:tkepin2}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[TKE quantile regression results. CFD in solid line.  Predicted values as dashed.]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/q_tke_regression_3} }}%
    \qquad
    \subfloat[Q-Q plot of TKE quantile regression predictions from LOO cross validation study]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/qq_tke_pin_3} }}%
    \caption[Q-Q LOO TKE pin 3 results.]{Pin 1 TKE quantile regression predictions from LOO cross validation study.}%
    \label{fig:tkepin3}%
\end{figure}


A subset of the Temperature residual quantile regression results are given in figure \ref{fig:temppin1} to \ref{fig:temppin3}.

\begin{figure}[H]%
    \centering
    \subfloat[Temperature quantile regression results. CFD in solid line.  Predicted values as dashed.]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/q_twall_regression_1} }}%
    \qquad
    \subfloat[Q-Q plot of Temperature quantile regression predictions from LOO cross validation study]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/qq_twall_pin_1} }}%
    \caption[Q-Q LOO Temperature pin 1 results.]{Pin 1 Temperature quantile regression predictions from LOO cross validation study.}%
    \label{fig:temppin1}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[Temperature quantile regression results. CFD in solid line.  Predicted values as dashed.]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/q_twall_regression_2} }}%
    \qquad
    \subfloat[Q-Q plot of Temperature quantile regression predictions from LOO cross validation study]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/qq_twall_pin_2} }}%
    \caption[Q-Q LOO Temperature pin 2 results.]{Pin 2 Temperature quantile regression predictions from LOO cross validation study.}%
    \label{fig:temppin2}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[Temperature quantile regression results. CFD in solid line.  Predicted values as dashed.]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/q_twall_regression_3} }}%
    \qquad
    \subfloat[Q-Q plot of Temperature quantile regression predictions from LOO cross validation study]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/qq_twall_pin_3} }}%
    \caption[Q-Q LOO Temperature pin 3 results.]{Pin 3 Temperature quantile regression predictions from LOO cross validation study.}%
    \label{fig:temppin3}%
\end{figure}

\subsection{Kendall's $\tau$ Regression}

A subset of the Kendall's $\tau$ regression results are given in figure \ref{fig:ktauregression}.

\begin{figure}[H]%
    \centering
    \subfloat[Pin 1]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/ktau_regression_1} }}%
    \qquad
    \subfloat[Pin 2]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/ktau_regression_2} }}%
    \qquad
    \subfloat[Pin 3]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/ktau_regression_3} }}%
    \qquad
    \subfloat[Pin 4]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/ktau_regression_4} }}%
    \qquad
    \caption[Kendall's $\tau$ regression LOO results.]{Kendall's $\tau$ regression results from LOO cross validation study.}%
    \label{fig:ktauregression}%
\end{figure}


\subsection{Copula Classifier}

Here we compute the classification error rate and summarize the model's performance with a confusion matrix.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/confusion_matrix_avg}
    \caption[Copula classifier confusion matrix.]{Copula classifier confusion matrix.}
    \label{fig:confusionmatrixavg}
\end{figure}


The copula classifiers performance averaged over all pins is shown in figure \ref{fig:confusionmatrixavg}. The copula classifier struggles to predict the correct copula class given the local TH state and axial core position.  As indicated in figures ()-(), the behavior of the copula as a function of axial rod position are erratic and inconsistent from pin to pin.  Introducing other TH exogenous variables in addition to the axial position did not increase the classification score significantly.  We can conclude that the copula are not well described by local core condition and axial position.  It remains as future work to investigate if including additional geometric pin and grid attributes could improve the classification results.  Additional software infrastructure would be required to both write geometric pin and grid features from CTF and to utilize the geometric features in the current model.

On average the classifier predicts an incorrect result more often than not.  This poor performance leads to the question:  What is the consequence of assuming a particular copula class for all CTF surfaces in lieu of poor quality copula class predictions?  First a single patch can selected to study the influence of a particular copula selection while retaining the same marginal distributions on the crud result.  The choice of copula is shown to have a small but statistically significant influence on the integrated crud and crud boron result in a particular CTF patch.  A larger scale study was also carried out.

Substituting the gradient boosted copula classifier with a constant copula assumption on the assembly scale is shown in figure ().  A cancellation of error effect from patch to patch is hypothesized to explain the close agreement in the crud preconditions made over the entire assembly.

\section{Single Pin Comparisons}

\begin{itemize}
    \item (\checkmark-) Show Kendall's tau vs Axial position for a single pin.  The rank correlation coefficient shows
    the influence of spacer grids on the joint distribution of temperature and turbulent kinetic energy.
    \item ($\cdot$) Show predicted Copula as a function of axial position.  Is there a clear trend here (i.e. is a guassian copula
    a good fit far away from spacer grids and the clayton copula a better fit near spacer grids?  (TODO: create this plot functionality - capability to compute best-fit copula already exists)
    \item (\checkmark-) Compare Gaussian vs best-fit copula crud results.
    \item (\checkmark-) Show axial crud comparisons for a single hi2lo, CFD and CTF pin.
    \item (\checkmark-) Show integrated crud comparisons for a single hi2lo, CFD and CTF pin.
\end{itemize}

\section{Multi Pin Comparisons}

\begin{itemize}
    \item (\checkmark-) Exercise hi2lo method with 5x5 CFD data set.
    \item (\checkmark-) Show pin-by-pin statistics to show if a geometric bias is present.  Are we always over predicting crud
    in pins near the edge of the assembly?
    \item (\checkmark-) Show axial CFD vs CTF vs hi2lo results for each pin.
    \item (\checkmark-) Compare total integrated assembly crud mass and boron bass for CFD vs CTF vs hi2lo.
\end{itemize}

\subsection{Multi State Point 5x5 Results}

\begin{itemize}
	\item ($\cdot$) Step a 5x5 assembly forward in time using pre-computed ctf-mpact results as input to the hi2lo model with the trained ML model supplying quantiles and copula.
	\item ($\cdot$) Report hi2lo crud model results under:
	\begin{itemize}
		\item ($\cdot$) Changes in power shapes.
		\item ($\cdot$) Changes in total rod power.
		\item ($\cdot$) Changes in flow rate.
	\end{itemize}
	
\end{itemize}
