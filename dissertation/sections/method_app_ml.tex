%! TEX root = ../dissertation_gurecky.tex
\label{sec:ml_cfd}

For deployment as an in-line statistically based downscaling tool which sits between a subchannel code and a crud simulation code in a core simulator such as VERA the model is required to perform the hi2lo mapping for all pins in the core at any operating condition.  In other words, the model must be evaluable at any local core conditions typical of an operating PWR.  Since the training data set cannot contain all possible pin geometries, loading configurations and operating conditions due to computational expense, the model produces a prediction for the copula and marginal distribution parameters between known states.

One might envision a table-lookup approach where high fidelity CFD flow field maps are pre-computed and stored for a wide array of flow and power conditions.  A nearest neighbor interpolation scheme could then be applied to extract the best-matching CFD map provided some local core state by VERA.  This is not tractable since the number of CFD computations to build the data base would be prohibitively large.  Instead of storing spatial CFD hi2lo maps, CFD data is distilled into a set of statistics tabulated as a function of local core state.

% It is appealing to transform the problem of hi2lo construction from performing spatial flow map prediction into one of summary statistics prediction where much less information is required adequately fill out the operating envelope.

In this chapter the hi2lo methodology introduced in this work is exercised against a small CFD data set derived from a 5x5 fuel assembly operating at realistic PWR conditions.  A leave-one-out cross validation strategy is used to assess the predictive performance of the model.


\section{CFD Data Source}
\label{sec:cfd_data_source}

For the generation of high fidelity CFD data sets the Westinghouse 5x5 test stand shown in figures \ref{fig:5x5topdown} and \ref{fig:5x5side} was used to prepare the CAD geometry.  The CFD mesh consisted of approximately 25 million cells and 1e5 surface elements per pin.  A matching CTF input deck for the 5x5 assembly was also constructed with 100 axial zones.  The CTF and CFD codes were then executed for a variety of flow conditions and power levels.  StarCCM+ was utilized for the CFD simulations in this work.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/5x5/5x5_top_down}
    \caption[Top down view of 5x5 pin Westinghouse facility.]{Top down view of 5x5 pin Westinghouse facility.  Assembly dimensions and pin powers redacted.}
    \label{fig:5x5topdown}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/5x5/5x5_side}
    \caption[Side view of 5x5 pin Westinghouse facility.]{Side view of 5x5 pin Westinghouse facility.  Pin dimensions redacted.}
    \label{fig:5x5side}
\end{figure}

For this rod configuration, the axial pin power, total power and CFD simulation rod surface temperature distributions are available in external references.  This information is purposely witheld from this document to protect the intellectual property of the Westinghouse electric company.


\subsection{Preprocessing}
\label{sec:preprocessing}

Preprocessing requires paired CFD and CTF results for a given pin generated with consistent boundary conditions between the codes.  This requires consistent geometry, inlet, outlet and power distributions between the codes.

The cladding surface temperature and near-wall TKE CFD fields are spatially aggregated onto the CTF face centers.  The aggregation requires that the location and extent of each CTF face is known.  These CTF face attributes are accessible from a CTF output file.  In the aggregation procedure spatial information is discarded within each CTF patch as the spatial fields are agglomerated into sample distributions.
In each CTF face each of the features given in table \ref{tab:features} are computed from the available CTF (or VERA) results.
The aggregated CFD data fields are then associated with their corresponding feature set.
In each face, the aggregated CFD field distributions are subtracted from the mean CTF predictions and the resultant (CFD-CTF) residual distributions are stored in a HDF5 table along with the associated predictive variables.

Next, correlation statistics are computed from the residual distributions.
Copula fitting by the maximum likelihood method with AIC model selection is carried out on each CTF face.  Additionally, the empirical Kendall's $\tau$ rank correlation coefficient is computed from the raw CFD data on each CTF face. Figure \ref{fig:copula_predicted} shows the copula parameters estimated from the raw CFD data on each pin as a function of axial position for the first 4 pins in the 5x5 CFD model.  There is a marked change in behavior of the copula between the pins.  This was an unexpected find since the flow patterns were speculated to be reasonably consistent from pin to pin.  Also, the influence of spacer grids on the correlation coefficient between the temperature and TKE fields is visible.  Across spacer grids the correlation coefficient sharply falls indicating a tighter coupling between the TKE and temperature surface fields as the flow necks down when entering a grid.  This is followed by a sharp change in Kendall's $\tau$ towards zero indicating the temperature and TKE surface fields become less correlated immediately following the mixing vanes.  This change in correlation behavior is posited to be due to turbulent mixing effects.  The computed copula parameters are also stored alongside the raw temperature, TKE, and boundary heat flux aggregated residual distribution data in the HDF5 table.

\begin{figure}[H]%
    \centering
    \subfloat[Pin 1]{{\includegraphics[width=0.45\linewidth]{figs/preproc/copula_params_pin_1} }}%
    \qquad
    \subfloat[Pin 2]{{\includegraphics[width=0.45\linewidth]{figs/preproc/copula_params_pin_2} }}%
    \qquad
        \subfloat[Pin 3]{{\includegraphics[width=0.45\linewidth]{figs/preproc/copula_params_pin_3} }}%
    \qquad
        \subfloat[Pin 4]{{\includegraphics[width=0.45\linewidth]{figs/preproc/copula_params_pin_4} }}%
    \qquad
    \caption[Best fitting copula to CFD data.]{Best fitting copula determined by AIC model selection as a function of axial rod position.}%
    \label{fig:copula_predicted}%
\end{figure}

After pre-processing, the HDF5 table includes a list of predictive scalar values, which are shown in table \ref{tab:features}, and a list of associated response variables comprised of the copula parameters and residual sample distribution for $\{T,k,q''\}$ on each CTF face.

\subsection{Feature Engineering}

The objective of feature engineering is to select a predictive variable set that can describe the behavior of the conditional quantiles and copula everywhere in the assembly.

\begin{table}[h]
    \begin{center}
    \caption[Included exogenous training features.]{Features included in the gradient boosted models as exogenous variables.}
\begin{tabular}[h]{|l | l | l | l |}
    \hline
    Sym & Label & Feature & Unit \\
    \hline
    \hline
    $T$ & ctf\_twall\_avg & CTF Face surface temperature & $[K]$ \\
    $R_T$ & ctf\_twall\_range & Surface temperature range in 4 adjacent faces & $[K]$ \\
    $q''$ & ctf\_bhf\_avg & Local CTF face heat flux & $[W/m^2]$ \\
    $R_{q''}$ & ctf\_bhf\_range & Heat flux range in 4 adjacent faces & $[W/m^2]$ \\
    $u_z$ & w\_bulk & CTF subchannel bulk Z Velocity &  $[m/s]$ \\
    $k$ & ctf\_tke\_avg & Local CTF face near wall TKE &  $[J/kg]$ \\
    $R_k$ & ctf\_tke\_range & CTF TKE range in 4 adjacent faces & $[J/kg]$ \\
    $z$ & z & Global axial position & $[m]$ \\
    $\delta z_g$ & dz\_grid & Position relative to nearest spacer grid & $[m]$ \\
    $N_g$ & n\_upsteam\_grid  & Nearest upstream spacer grid ID & $[]$ \\
    $T_\infty$ & t\_bulk & Subchannel bulk temperature  &  $[K]$ \\
    \hline
\end{tabular}
\label{tab:features}
\end{center}
\end{table}

The predictive variables given in table \ref{tab:features} were selected based on two criteria:  Availability and orthogonality.  In order to evaluate the trained machine learning model at a TH state point each conditioning variable should be made available by VERA or must be computable from CTF results and supplied as input to the trained machine learning models.   The exogenous variable set given in table \ref{tab:features} comprise the local core conditions, or TH conditions at any given CTF face.  The machine learning model uses the local core conditions as the exogenous feature set, thus these features must be supplied to the fitted gradient boosted regressors at runtime in order to evaluate the model.

% This has to be true since when evaluating the hi2lo model the inputs to the hi2lo model are required to be derived from either previously stored information or information made available by CTF at runtime.

At this juncture, the availability criteria precludes using some geometric information such as the orientation of a given spacer grid since it is not possible to extract or infer this information from the CTF output.  Including additional geometric information into the exogenous variable set could potentially increase the ability of the machine learning models to distinguish unique CTF faces in the core though testing of this hypothesis is left to a future investigation.  Additional software infrastructure is required to include and extract additional features from the CTF or VERA output files.

It is not useful to include features which are co-linear into the explanatory feature set. The bulk fluid density was not included in the predictive variable set as it strongly depends on the local temperature. Likewise the local static pressure was not used as a predictive variable since this would be approximately one-to-one with the axial position.  The exclusion of this TH information is primarily done for computational saving when training the boosted models since, as opposed to other machine learning algorithms and statistical inference techniques, gradient boosting is robust to collinearity of features in the input space.

In the case of gradient boosting the inclusion of nuisance or collinear exogenous variables in the model will not necessarily reduce the model's ability to generalize to unseen data, only hamper computational efficiency.  The resulting feature importance plot shown in figure \ref{fig:ktauregfeatureimp} suggests that the relative axial position within a span does not provide predictive power since this information is redundant provided the absolute axial position and the nearest upstream spacer grid are included in the feature set.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\linewidth]{figs/ktau_reg_feature_imp}
    \caption[Relative feature importance.]{Relative feature importances on Kendall's $\tau$.}
    \label{fig:ktauregfeatureimp}
\end{figure}

Since the boosted regression (and classification) models are insensitive to multi-collinearity in the feature space, the application of principal component analysis to the training data set was not pursued.


\subsection{Cross Validation}

An estimate of the crud prediction error incurred when evaluating the trained models at unknown CFD states can be made by performing a leave one out (LOO) cross validation study.  Cross validation is used to estimate how well the machine learning models employed in this work generalized to previously unseen local core conditions; i.e. core conditions that are not included in the training data set.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.3\linewidth]{figs/drawings/5x5_loo}
    \caption[Example pin layout for leave-one-out cross validation procedure.]{Example pin layout for leave-one-out cross validation procedure.  The gradient boosted models are trained on CFD and CTF data extracted from the blue pins.  Crud predictions are made on the missing pin.}
    \label{fig:5x5loo}
\end{figure}

The LOO cross validation procedure is depicted in figure \ref{fig:5x5loo}.  In this procedure a single CFD-CTF pin pair is removed from the database and then the model is trained on remaining data.  Following data culling and training, the machine learning model is evaluated and crud predictions are made at the missing pin's TH conditions.
The predicted crud results are compared against crud results generated using the original CFD data for the missing pin.  This process is repeated for each pin in the 5x5 assembly.
% The differences are summarized and averaged to obtain a measure of model's predictive performance when applied to TH conditions that reside in the TH envelope included in the training set.

This cross validation technique ascertains crud prediction errors within the TH envelope enclosed by the original full 25 pin training set.  The resulting crud prediction error estimates cannot be extrapolated to core conditions that lay outside of the thermal hydraulic envelope formed by the training set.  For a robust crud prediction error analysis, a much larger training data set is required which would essentially span all possible TH conditions encountered in an operational PWR.  This will require large scale CFD runs and is left as a avenue for future uncertainty quantification work.  A larger training set would also increase the viability of other multi-fold cross validation techniques which require permutations of stratified chunks to be excised from the training pool in their application.  This would involve removing multiple pins from the training set.

\subsection{Quantile Regressors}

A principal goal of the machine learning model is to predict the conditional quantiles of the temperature and TKE distributions as a function of local core conditions.  In this light, the trained quantile regression models are compared against the left-out CFD data set on each pin.  The accuracy of both the TKE and temperature quantile regressors is assessed using both quantile-quantile plots and quantile vs axial rod position comparisons.

Quantile-quantile (Q-Q) plots of the temperature and TKE residual distributions are used to elucidate bias introduced by the machine learning model in the conditional quantiles at a variety of axial positions and local core conditions.  Estimated quantiles are obtained for the left-out pin by evaluating the trained reduced LOO model and are compared to the expected CFD result.
A subset of the TKE residual quantile regression results are given in figures \ref{fig:tkepin1} to \ref{fig:tkepin3}.  A complete set of quantile regression results are provide in chapter \ref{chap:app_ml}, Appendix A. The Q-Q plots summarize the biases in the conditional quantile distributions when compared to the target golden standard CFD data.  The maximum and average Kolmogorov–Smirnov (KS) statistic is provided in the Q-Q figures for each pin which can be computed by equation \ref{eq:ks_stat}.
\begin{equation}
    KS = \mathrm{sup}(\{\hat F(q_{\tau}) - F(q_{\tau})\})
\label{eq:ks_stat}
\end{equation}
\index{Kolmogorov–Smirnov Testing}

Where $\mathrm{sup}(\cdot)$ is the supremum of the set of distances between the predicted and empirical cumulative densities.  The cumulative densities are supported at the specified quantile levels: $\{\mathbf \tau\} = \{0.000, 0.0526, 0.1052, ... 1.000 \}$ since the number of quantiles used in the reconstruction of the marginal temperature and TKE distributions was set to be 20 and were evenly spaced.
The KS statistic was computed at each axial level on the CTF grid.

A two sample KS test was performed on the temperature and TKE distribution reconstructions from predicted quantiles on each CTF face. The null hypothesis is that the predicted and empirical (CFD derived) distributions are the same on the CTF face.  To reject the null hypothesis the KS distance must satisfy the inequality presented in equation \ref{eq:ks_crit}.

\begin{equation}
    KS_D^* > c(\alpha) \sqrt{\frac{n+m}{nm}}
\label{eq:ks_crit}
\end{equation}

Where $n=20$ in this case since the predicted CDFs are supported at 20 locations. The number of samples available to construct the empirical distribution, $m$, on each face was $\approx200$, though this varied slightly from face to face.  In general $c(\alpha) = \sqrt{-\frac{1}{2} \mathrm{ln}\alpha}$, therefore at $\alpha=0.1$, $KS_D^* \approx 0.253$.  A summary of the KS distances and test results are provided in table \ref{tab:ks_temp} for the temperature quantiles and in table \ref{tab:ks_tke} for the predicted TKE quantiles.

\begin{table}[h]
    \begin{center}
    \caption[KS statistic TKE summary.]{TKE distribution KS statistic summary. Values in bold result in rejection of the null hypothesis at significance level $\alpha=0.1$.}
    \begin{tabular}[h]{|c|c|c|}
        \hline
        Pin & $KS_\mu$ & $KS_{max}$ \\
\hline
1 &  2.949e-02 &  \textbf{3.7027e-01} \\
2 &  8.487e-02 &  \textbf{3.7030e-01} \\
3 &  2.999e-02 &  1.9407e-01 \\
4 &  1.111e-01 &  5.5811e-01 \\
5 &  3.175e-02 &  1.8512e-01 \\
6 &  2.891e-02 &  2.3469e-01 \\
7 &  4.466e-02 &  2.2317e-01 \\
8 &  5.642e-02 &  \textbf{3.2113e-01} \\
9 &  1.943e-02 &  1.3405e-01 \\
10 & 5.650e-02 & \textbf{2.8362e-01} \\
11 & 3.155e-02 & 1.5097e-01 \\
12 & 6.701e-02 & \textbf{4.3280e-01} \\
13 & 3.847e-02 & 2.3050e-01 \\
14 & 4.220e-02 & \textbf{3.5174e-01} \\
15 & 5.040e-02 & 2.7588e-01 \\
16 & 9.001e-02 & \textbf{4.1846e-01} \\
17 & 2.129e-02 & 2.0583e-01 \\
18 & 2.702e-02 & 1.7656e-01 \\
19 & 2.959e-02 & 1.5939e-01 \\
20 & 3.804e-02 & 1.8140e-01 \\
21 & 3.092e-02 & 2.3890e-01 \\
22 & 2.263e-02 & 1.6278e-01 \\
23 & 2.181e-02 & 1.4727e-01 \\
24 & 3.227e-02 & 1.3258e-01 \\
25 & 2.728e-02 & 1.5842e-01 \\
\hline
\end{tabular}
\label{tab:ks_tke}
\end{center}
\end{table}

By inspecting the KS test results presented in tables \ref{tab:ks_tke} and \ref{tab:ks_temp} it can be concluded that the prediction of the conditional temperature distribution on each CTF face was far more difficult than predicting the conditional TKE distribution.  A large maximum KS temperature distribution distance was seen for the majority of the pins in the assembly. The worst performing pins in this respect were pin 4, pin 9, and pin 20. This is due to the aforementioned high span-to-span and pin-to-pin repeatability of the TKE distributions and conversely the low repeatability of the temperature distribution.  Since the maximum KS distance can occur in CTF faces which do not contain temperatures in excess of the saturation point, the maximum KS distance is not an indicator of poor crud predictive performance.  The presented KS tests only serve to quantify the ability of the gradient boosted quantile regressors to reproduce the expected distributions.

Pin-average KS distances indicate that the the null hypothesis was not rejected in the majority of CTF faces, however.  This indicates that the distributions predicted by the gradient boosted quantile regressors were, on average, statistically indistinguishable from the empirical CFD distributions. 

\begin{table}[h]
    \begin{center}
    \caption[KS statistic temperature sumarry.]{Temperature distribution KS statistic summary. Values in bold result in rejection of the null hypothesis at significance level $\alpha=0.1$.}
    \begin{tabular}[h]{|c|c|c|}
        \hline
        Pin & $KS_\mu$ & $KS_{max}$ \\
\hline
1 &  4.329e-02 &  \textbf{3.2094e-01} \\
2 &  8.477e-02 &  \textbf{3.9065e-01} \\
3 &  6.725e-02 &  \textbf{4.4959e-01} \\
4 &  1.509e-01 &  \textbf{6.0957e-01} \\
5 &  4.483e-02 &  \textbf{2.7359e-01} \\
6 &  8.718e-02 &  \textbf{4.4920e-01} \\
7 &  8.848e-02 &  \textbf{3.2938e-01} \\
8 &  5.668e-02 &  \textbf{4.2560e-01} \\
9 &  7.273e-02 &  \textbf{6.3407e-01} \\
10 & 1.292e-01 &  \textbf{4.6647e-01} \\
11 & 6.765e-02 &\textbf{ 3.5969e-01} \\
12 & 1.124e-01 & \textbf{4.9874e-01} \\
13 & 5.064e-02 & \textbf{3.2152e-01} \\
14 & 6.728e-02 & \textbf{4.7099e-01} \\
15 & 1.429e-01 &\textbf{ 5.4111e-01} \\
16 & 7.260e-02 & \textbf{3.9793e-01} \\
17 & 3.975e-02 & 2.3933e-01 \\
18 & 3.209e-02 & 2.5577e-01 \\
19 & 6.852e-02 &\textbf{ 3.7904e-01} \\
20 & 1.273e-01 &\textbf{ 8.3754e-01} \\
21 & 3.059e-02 &\textbf{ 3.8896e-01} \\
22 & 1.147e-01 &\textbf{ 6.6852e-01} \\
23 & 6.098e-02 &\textbf{ 4.6728e-01} \\
24 & 6.525e-02 &\textbf{ 4.7225e-01} \\
25 & 4.811e-02 & \textbf{ 3.3235e-01} \\
\hline
\end{tabular}
\label{tab:ks_temp}
\end{center}
\end{table}


Caution should be observed when drawing conclusions from this goodness-of-fit study.
The two sample KS test is generally regarded as a statistically weak, requiring a relatively large number of samples and high KS distance to reject the null hypothesis \cite{ks_power} \cite{KHAMIS1990317}.  The statistical power of a hypothesis test is defined as the probability of avoiding a type II error.  In the currently considered case there is high probability of committing type II errors, or in other words, failing to reject the null hypothesis.  For this reason and provided only 20 quantiles available for use in the KS test there is insufficient evidence to conclude the gradient boosted quantile regression models properly reproduced the expected temperature and TKE distributions on each face.  In future work, a larger number of CFD data points and larger number of quantile regressors should be used to improve the ability of the KS test to identify incongruence between the model predictions and the expected distributions.

Note that since a LOO CV technique was used for comparing the predicted distributions to the empirical CFD distributions complications in the KS test which arise when the parameters of the predicted distribution are estimated from the target empirical data set were avoided \cite{kstestInfo}.   Under these circumstances the KS test would no longer be valid though methods based on bootstrap resampling have been proposed to resolve this specific limitation of the traditional KS test \cite{kstestInfo}.


\begin{figure}[H]%
    \centering
    \subfloat[TKE quantile regression results. CFD in dashed line.  Predicted values as solid.]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/q_tke_regression_1} }}%
    \qquad
    \subfloat[Q-Q plot of TKE quantile regression predictions from LOO cross validation study]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/qq_tke_pin_1} }}%
    \caption[Q-Q LOO TKE pin 1 results.]{Pin 1 TKE quantile regression predictions from LOO cross validation study.}%
    \label{fig:tkepin1}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[TKE quantile regression results. CFD in dashed line.  Predicted values as solid.]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/q_tke_regression_2} }}%
    \qquad
    \subfloat[Q-Q plot of TKE quantile regression predictions from LOO cross validation study]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/qq_tke_pin_2} }}%
    \caption[Q-Q LOO TKE pin 2 results.]{Pin 2 TKE quantile regression predictions from LOO cross validation study.}%
    \label{fig:tkepin2}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[TKE quantile regression results. CFD in dashed line.  Predicted values as solid.]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/q_tke_regression_3} }}%
    \qquad
    \subfloat[Q-Q plot of TKE quantile regression predictions from LOO cross validation study]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/qq_tke_pin_3} }}%
    \caption[Q-Q LOO TKE pin 3 results.]{Pin 3 TKE quantile regression predictions from LOO cross validation study.}%
    \label{fig:tkepin3}%
\end{figure}

Shown in the axial plots in figure \ref{fig:tkepin1} to \ref{fig:tkepin3}, the TKE distribution is drastically influenced by spacer grids.  The maximum near-wall TKE sharply increases following a spacer grid followed by a decay towards a more orderly flow.  The location of minimum predicted near wall TKE also immediately follows the spacer grids.  In addition to increasing the net turbulent kinetic energy of the flow, mixing vanes can also produce eddy regions of stagnant flow thus giving rise to regions of low near wall TKE.  The hi2lo model retains both of these properties of the flow field resolved by CFD.    

Good overall performance TKE quantile regression models can be attributed to high pin-to-pin and span-to-span similarities of the surface TKE distributions. The observation of high span-to-span repeatability of the TKE distributions is consistent with those found in other hi2lo studies by Salko et. al \cite{salko17}.

Temperature residual quantile regression results are given in figures \ref{fig:temppin1} to \ref{fig:temppin3}.  Similar to the TKE conditional quantiles, the conditional temperature distribution exhibits sharp changes in behavior across the spacer grids. Unlike the TKE residual distribution the surface temperature distributions do not exhibit the same degree of similarity from span to span or from pin to pin.  The presence of discontinuities in the temperature distributions enforced the choice of the gradient boosted tree machine learning algorithm which is resilient to steep gradients in the response surface.

\begin{figure}[H]%
    \centering
    \subfloat[Temperature quantile regression results. CFD in dashed line.  Predicted values as solid.]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/q_twall_regression_1} }}%
    \qquad
    \subfloat[Q-Q plot of Temperature quantile regression predictions from LOO cross validation study]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/qq_twall_pin_1} }}%
    \caption[Q-Q LOO Temperature pin 1 results.]{Pin 1 Temperature quantile regression predictions from LOO cross validation study.}%
    \label{fig:temppin1}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[Temperature quantile regression results. CFD in dashed line.  Predicted values as solid.]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/q_twall_regression_2} }}%
    \qquad
    \subfloat[Q-Q plot of Temperature quantile regression predictions from LOO cross validation study]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/qq_twall_pin_2} }}%
    \caption[Q-Q LOO Temperature pin 2 results.]{Pin 2 Temperature quantile regression predictions from LOO cross validation study.}%
    \label{fig:temppin2}%
\end{figure}

\begin{figure}[H]%
    \centering
    \subfloat[Temperature quantile regression results. CFD in dashed line.  Predicted values as solid.]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/q_twall_regression_3} }}%
    \qquad
    \subfloat[Q-Q plot of Temperature quantile regression predictions from LOO cross validation study]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/qq_twall_pin_3} }}%
    \caption[Q-Q LOO Temperature pin 3 results.]{Pin 3 Temperature quantile regression predictions from LOO cross validation study.}%
    \label{fig:temppin3}%
\end{figure}

Inspecting the axial quantile difference figures \ref{fig:temppin1}a to \ref{fig:temppin3}a, on average the extreme quantiles exhibit the largest axial RMS prediction errors.  This is expected behavior since the estimates the extreme quantiles from a sample population is naturally fraught with high variance as described by equation \ref{eq:theory_qdist_1}.  Recall that this fact was also experimentally demonstrated using a simple test quantile regression problem in section \ref{chap:GBRT}.  In both cases the distribution of the residuals between the gradient boosted quantile predictions and the empirical sample quantiles increased in variance when estimating the more extreme conditional quantiles.


\subsection{Kendall's $\tau$ Regression}

The rank correlation coefficient, Kendall's $\tau$ ($\rho_\tau$), is used to quantify the strength of dependence between the temperature and TKE on the rod surface in each CTF face.  A separate gradient boosted regression model was tasked with predicting this statistic as a function of local core conditions.   The growth rate of crud was shown to be sensitive to   $\rho_\tau$ in section \ref{sec:crud_copula_sensi}, figure \ref{fig:patchcrudfit80}.  It is therefore important to understand the error and uncertainty carried by the predicted $\hat \rho_\tau$ values in each CTF face.

A subset of the 5x5 assembly's Kendall's $\tau$ regression results are given in figure \ref{fig:ktauregression} and the complete 5x5 $\rho_\tau$ LOO cross validation results are given in figure \ref{fig:ktauregressionmontage}.  There is a marked change in behavior of the rank correlation coefficient as a function of axial position in the core from pin to pin.  The influence of Kendall's $\tau$ on the CTF face-integrated crud results was discussed in section \ref{sec:crud_copula_sensi}, and it was shown to be an important parameter to accurately predict via the machine learning model.  Pins with large relative errors for Kendall's $\tau$ are expected to produce anomalously poor crud predictions.

The worst performing pin with respect to $\hat \rho_\tau$ prediction was pin 8, as indicated in figure \ref{fig:ktauregressionmontage}.  Interestingly, this pin exhibited relatively good agreement between the predicted crud distribution and the expected CFD crud distribution as indicated in table \ref{tab:loo_crud_bmass} and figure \ref{fig:montageaxialbmasssm}.  This pin, was relatively cold in comparison to the others in the fuel bundle which resulted growing only $5.9$e-2 $[g]$ of crud in 300 days when the hottest rods grew $\approx 1.4$e0 $[g]$ in the same time.  In the case of pin 8, since the majority of the rod surface exists below the saturation point the crud result was not sensitive to the shape of the joint temperature and TKE distributions, and thus, even with poor $\rho_\tau$ predictions the axial and integrated crud results agree with the original CFD result.

\begin{figure}[H]%
    \centering
    \subfloat[Pin 1]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/ktau_regression_1} }}%
    \qquad
    \subfloat[Pin 2]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/ktau_regression_2} }}%
    \qquad
    \subfloat[Pin 3]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/ktau_regression_3} }}%
    \qquad
    \subfloat[Pin 4]{{\includegraphics[width=0.45\linewidth]{figs/ml_fit/ktau_regression_4} }}%
    \qquad
    \caption[Kendall's $\tau$ regression LOO results.]{Kendall's $\tau$ regression results from LOO cross validation study.}%
    \label{fig:ktauregression}%
\end{figure}
To improve the performance of the Kendall's $\tau$ regressors, a larger training set could be generated in future work.  For this limited 25 pin data set, it is hypothesized that each pin has a substantially unique flow field when compared to the other 24 pins.  Expelling a pin from the training data set for cross validation causes the predictive performance of the model to suffer since the remaining pins in the training set do not provide the requisite information about the local core conditions vs. Kendall's $\tau$ relationship for the missing pin.

\subsection{Copula Classifier}

In addition to the rank correlation coefficient, Kendall's $\tau$, the copula family is also required to recover the copula density function on each CTF face.  To this end a gradient boosted classifier was trained on the available CFD data.  Copula information extracted from the raw CFD results is shown in figure \ref{fig:copula_predicted}.

Figure \ref{fig:confusionmatrixavg} summarizes the LOO cross validation results of the copula classifier as a confusion matrix.  The diagonal entries of the confusion matrix represent the correctly labeled copula predictions made by the reduced LOO trained classifier for each copula family average over the entire 5x5 assembly.  It is shown that on average the classifier predicts an incorrect result more often than not.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/confusion_matrix_avg}
    \caption[Copula classifier confusion matrix.]{Copula classifier confusion matrix.}
    \label{fig:confusionmatrixavg}
\end{figure}


It is clear that the copula classifier struggles to predict the correct copula class given the local TH conditions.  As previously indicated in figure \ref{fig:copula_predicted}, the behavior of the copula as a function of axial rod position is erratic and inconsistent from pin to pin.  This erratic behavior proved too difficult to capture provided the limited training data set.  It is not possible to conclude that the copula are well-described by the local thermal hydraulic conditions and axial position.  It remains as future work to investigate if including additional geometric pin and grid attributes could improve the classification results.  Additional software infrastructure would be required to both write geometric pin and grid features from the CTF code and to utilize these geometric features in the current model.

Future work could include performing a transformation of the input space so that the copula family labels are separable in the transformed space.  A Potential candidate for building this transformation is the UMAP manifold learning algorithm \cite{UMAP18}.

Further improvements in prediction accuracy are possible by applying an ensemble
machine learning technique known as stacking.  Stacking combines the predictions of multiple classifiers using a meta-classifier.
Stacking increases model complexity since each classifier in the ensemble contains hyper-parameters which require tuning.
Since ML model tuning and performance is not a focus of this work, the application of this technique to improve copula classification results is left as future work.

Though improvements are possible, it should also be noted that section \ref{sec:crud_copula_sensi} and table \ref{tab:crud_totals_copula} show that the copula family does not substantially influence pin integrated crud results.  Due to this, gains in the copula classifier accuracy will not necessarily translate to a large improvement in crud prediction accuracy.

\section{Crud Results}

The presented case considered the 5x5 array operating at a single state with fixed power profile and flow conditions for 300 days.  The hi2lo model was marched forward in time using a re-sampling step size of 50 days.  A sample size of 400 was used to estimate the crud distribution in each CTF face.  The importance sampling distribution parameters were set to values given in table \ref{tab:hi2lo_params}.  The default remapping weights of $w_T=0.4, \ w_k=0.6$ were used in this case.

The comparisons presented are the result of the LOO cross validation study.
Ergo the hi2lo model was used in a properly predictive manner since distribution parameters had to be inferred from the machine learning model at local core conditions outside of the training set.

The error estimates provided by the present LOO cross validation study can be viewed as conservative.  The LOO strategy expunged an entire pin from an already limited training pool of only 25 pins . This is not representative a production-ready training data set.  A training set to be used in production environment will have all possible pin geometries represented within it; that is all possible pin configurations within a bundle.  Not all combinations of inlet and power conditions will be simulated by CFD due to computational time limitations and so interpolation error can be expected even if a provided a geometrically rich training set.  

% If the flow fields are principally governed by geometric factors the 

% A question for future invesigation is decomposing the interpolation error into parts:  how much interpolation error is attributed to geometric factors vs thermal hydraulic ones.

%If the shape of the flow fields are primarily driven to first order by geometric factors, missing thermal hydraulic conditions is a less impactful a hole in the parameter space than a pin-geometry hole.

\subsection{Single Pin Comparisons}
\label{sec:single_pin_result}

A single pin was selected from the 25 pin array for detailed comparison of the CFD, CTF, and hi2lo models.  For this pin, axial crud distribution comparisons were made at 300 $[days]$ of simulation time are shown in figures \ref{fig:15axialbmass} and \ref{fig:15axialcmass}.  Axial crud distributions of all pins are provided in appendix B.  The CTF standalone case generally predicts a greater amount of crud at all axial positions.  Since the CTF model did not include any grid-enhanced heat transfer model it is to be expected that surface temperature downstream spacer grids would be over-predicted since the influence of the mixing vanes on the rod surface temperature distributions are partially neglected.  The Hi2lo model preserves the influence of the spacer grids on the crud distributions predicted by CFD computations.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/1_5_axial_bmass}
    \caption{Pin 1 CTF vs CFD vs Hi2lo axial crud boron mass distribution at 300 days.}
    \label{fig:15axialbmass}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/1_5_axial_cmass}
    \caption{Pin 1 CTF vs CFD vs Hi2lo axial crud mass distribution at 300 days.}
    \label{fig:15axialcmass}
\end{figure}

The total crud mass and total boron hideout mass were computed at each re-sampling step and presented in figures \ref{fig:15pinbmasstime} and \ref{fig:15pincmasstime}.  The time evolution of the crud total mass for all pins is given in appendix B.  The hi2lo model under predicted the crud mass on pin 1 when compared to the CFD model.



\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/1_5_pin_bmass_time}
    \caption{Pin 1 CTF vs CFD vs Hi2lo integrated crud boron mass distribution as a function of time.}
    \label{fig:15pinbmasstime}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/1_5_pin_cmass_time}
    \caption{Pin 1 CTF vs CFD vs Hi2lo integrated crud mass distribution as a function of time.}
    \label{fig:15pincmasstime}
\end{figure}

Figures \ref{fig:2d_hi2loimppinbmass} and \ref{fig:2d_hi2loimppincmass} show the hi2lo predicted crud surface distributions at 300 days.  The result of re-ordering samples onto each CTF face to preserve hot spot stationarity in time is visible.  The stripped patterns are non-physical and are an artifact of the remapping procedure.  Recall that the overarching goal is not to reproduce the detailed intra-CTF face spatial crud distributions rather the model specifically attempts to reproduce the correct average crud behavior on each CTF face, even in regions near spacer grids, and estimate the frequency of extreme crud events so to be relevant for CILC risk estimates.
Note that the crud surface field results are left in the area-normalized form with units of $[g/cm^2]$ which is the natural result from the 1D crud growth package.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/tstep_5/pin_1/hi2lo_imp_pin_bmass}
    \caption{Pin 1 hi2lo 2D surface map of crud boron mass density.}
    \label{fig:2d_hi2loimppinbmass}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/tstep_5/pin_1/hi2lo_imp_pin_cmass}
    \caption{Pin 1 hi2lo 2D surface map of crud mass density.}
    \label{fig:2d_hi2loimppincmass}
\end{figure}

The average crud behavior as a function of axial position along the rod is given in figures \ref{fig:15axialbmass} and \ref{fig:15axialcmass}.  The axial crud root-mean-squared error is given in table \ref{tab:loo_crud_bmass} alongside other pins in the assembly.  Pin 1 exhibits good agreement between the hi2lo model's crud predictions and the CFD results for the axial crud distribution when compared to other pins in the assembly.  The rod integrated crud mass is also consistent between the two.

The crud density distributions predicted by the Hi2lo procedure are approximately consistent with the gold-standard CFD result as shown in figures \ref{fig:dist_hi2loimppinzbmass} and \ref{fig:dist_hi2loimppinzcthick}. Some difficulty in capturing the extreme quantiles of the crud distributions as a function of axial position along the pin is shown in the figures. 

The ability of the hi2lo model to accurately predict the fraction of the rod surface which experiences extreme crud thickness, a precursor quantity to CILC risk estimation, is hampered by limitations of the quantile regression and the relative sparsity of the available training data.  Recall that a given large-sample quantile follows a Gaussian distribution according to equation \ref{eq:theory_qdist_1}. By the propagation of uncertainty to upper tail integrals of the probability density detailed in equations \ref{eq:pr_thresh} and \ref{eq:pr_thresh_uncert}, estimates for extreme crud distribution quantiles (i.e. estimates of how much of the rod surface experiences crud with a thickness exceeding some critical CILC crud threshold) will have high variance.  Difficulty in predicting extreme quantiles by standard quantile regression reflects basic facts about the large sample limit of extreme quantiles.
Circumventing these difficulties is a non-trivial undertaking.  Without making assumptions for the functional form of the surface temperature distribution, thereby adopting a parametric model, it is difficult to estimate the likelihood of extreme crud events.

\begin{figure}[H]%
    \centering
    \subfloat[Hi2lo pin boron mass.]{{\includegraphics[width=0.46\linewidth]{figs/5x5/imp/tstep_5/pin_1/hi2lo_imp_pin_z_bmass} }}%
    \qquad
    \subfloat[CFD pin boron mass.]{{\includegraphics[width=0.46\linewidth]{figs/5x5/cfd/tstep_5/pin_1/CFD_pin_z_bmass} }}%
    \caption[Pin 1 crud boron mass density results at 300 days]{Pin 1 crud boron mass density results at 300 days.  Select crud quantiles are indicated via colored bands.}%
    \label{fig:dist_hi2loimppinzbmass}
\end{figure}


\begin{figure}[H]%
    \centering
    \subfloat[Hi2lo pin crud thickness.]{{\includegraphics[width=0.46\linewidth]{figs/5x5/imp/tstep_5/pin_1/hi2lo_imp_pin_z_cthick} }}%
    \qquad
    \subfloat[CFD pin crud thickness.]{{\includegraphics[width=0.46\linewidth]{figs/5x5/cfd/tstep_5/pin_1/CFD_pin_z_cthick} }}%
    \caption[Pin 1 crud thickness results at 300 days]{Pin 1 crud thickness results at 300 days.  Select crud quantiles are indicated via colored bands.}%
    \label{fig:dist_hi2loimppinzcthick}
\end{figure}


% Redundant since we already have tempearture and TKE results
% \begin{figure}[H]
%    \centering
%    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/tstep_5/pin_1/hi2lo_imp_pin_z_tke}
%    \caption{}
%    \label{fig:hi2loimppinztke}
% \end{figure}
% \begin{figure}[H]
%    \centering
%    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/tstep_5/pin_1/hi2lo_imp_pin_z_twall}
%    \caption{}
%    \label{fig:hi2loimppinztwall}
% \end{figure}

\subsection{Multi Pin Comparisons}
\label{sec:multi_pin_result}

Results for each pin in the LOO cross validation study are presented here.  There was random variation in the prediction accuracy of the model accross the 5x5 assembly with no apparent spatial bias in the model prediction errors towards the edge of the assembbly, as one may expect.  This would indicate that some pins in the 5x5 assembly are, in a sense, more unique with respect to thermal hydraulic flow conditions than others.  Pins where a small difference between the hi2lo model predictions and the gold-standard CFD result show that the pin's thermal hydraulic conditions are well represented in the training set.

In table \ref{tab:loo_crud_bmass} and \ref{tab:loo_crud_cmass} rod integrated crud results for each pin are given at 300 days of simulation time.  The worst performing pin with respect to boron deposition prediction was pin 4 by relative percent difference between the hi2lo result and the CFD driven crud result.  The Kendall's $\tau$ boosted regressor produced large prediction errors as measured by the LOO cross validation for this pin, as shown in table \ref{tab:loo_rms}.  Incorrect predictions made for the correlation coefficient act in concert with a net under-prediction of the temperature quantiles, as shown in figure \ref{fig:qqtwallmontagesm}, giving rise to a significant ($\approx -48\%$) net under prediction of the total crud mass on pin 4.


% Hi2lo Bmass results
\begin{table}[h]
    \begin{center}
    \caption[Hi2lo crud boron mass results]{Crud boron mass hi2lo LOO result summary at 300 days.}
    \begin{tabular}[h]{|c|c|c|c|c|c|}
        \hline
        Pin & CTF Bmass $[g]$ & CFD Bmass $[g]$ & Hi2lo Bmass $[g]$ & Hi2lo-CFD $[g]$ & Rel Diff \% \\
\hline
1  & 1.2940e-03 & 7.5489e-04 & 6.3163e-04 & -1.2326e-04 &  -16.3 \\
2  & 1.1458e-03 & 5.1953e-04 & 3.1487e-04 & -2.0466e-04 &  -39.4 \\
3  & 1.0265e-03 & 3.2678e-04 & 3.4192e-04 & 1.5140e-05 &  4.6 \\ 
4  & 1.0111e-03 & 5.6847e-04 & 2.9848e-04 & -2.6999e-04 &  $\bf{-47.5}$ \\
5  & 9.5319e-04 & 1.8974e-04 & 2.2723e-04 & 3.7490e-05 &  19.8 \\ 
6  & 4.0505e-04 & 9.1686e-05 & 1.0065e-04 & 8.9640e-06 &  9.8 \\ 
7  & 8.0907e-05 & 4.0210e-05 & 3.7515e-05 & -2.6950e-06 &  -6.7 \\
8  & 6.5705e-05 & 2.9861e-05 & 3.3475e-05 & 3.6140e-06 &  12.1 \\ 
9  & 6.7204e-05 & 3.3324e-05 & 3.3063e-05 & -2.6100e-07 &  -0.8 \\
10  &6.6850e-05 & 3.5892e-05 & 2.8171e-05 & -7.7210e-06 &  -21.5 \\
11  &8.7449e-05 & 4.0316e-05 & 3.7932e-05 & -2.3840e-06 &  -5.9 \\
12  &4.6693e-04 & 1.1722e-04 & 8.2669e-05 & -3.4551e-05 &  -29.5 \\
13  &1.0616e-03 & 2.2909e-04 & 2.6878e-04 & 3.9690e-05 &  17.3 \\ 
14  &1.0617e-03 & 2.7471e-04 & 3.9548e-04 & 1.2077e-04 &  44.0 \\ 
15  &1.0366e-03 & 4.5067e-04 & 3.3163e-04 & -1.1904e-04 &  -26.4 \\
16  &1.1594e-03 & 2.9707e-04 & 4.3385e-04 & 1.3678e-04 &  46.0 \\ 
17  &9.1090e-04 & 2.6739e-04 & 2.6569e-04 & -1.7000e-06 &  -0.6 \\
18  &7.1616e-04 & 2.3468e-04 & 2.0092e-04 & -3.3760e-05 &  -14.4 \\
19  &6.1329e-04 & 1.1289e-04 & 1.4341e-04 & 3.0520e-05 &  27.0 \\ 
20  &1.6370e-04 & 7.2277e-05 & 4.8991e-05 & -2.3286e-05 &  -32.2 \\
21  &1.2524e-04 & 4.5454e-05 & 4.4092e-05 & -1.3620e-06 &  -3.0 \\
22  &1.7007e-04 & 4.4576e-05 & 6.1729e-05 & 1.7153e-05 &  38.5 \\ 
23  &6.2594e-04 & 1.5092e-04 & 1.1521e-04 & -3.5710e-05 &  -23.7 \\
24  &7.1144e-04 & 1.8479e-04 & 2.1561e-04 & 3.0820e-05 &  16.7 \\ 
25  &4.1668e-04 & 1.3290e-04 & 8.6106e-05 & -4.6794e-05 &  -35.2 \\
\hline \hline
Totals & 1.5443e-02 & 5.2453e-03 & 4.7791e-03 & -4.6623e-04   & -8.88 \\
\hline
\end{tabular}
\label{tab:loo_crud_bmass}
\end{center}
\end{table}


% hi2lo cmass results
\begin{table}[h]
    \begin{center}
        \caption[Hi2lo crud mass results]{Crud mass hi2lo LOO result summary at 300 days.}
    \begin{tabular}[h]{|c|c|c|c|c|c|}
        \hline
        Pin & CTF Cmass $[g]$& CFD Cmass $[g]$& Hi2lo Cmass $[g]$& Hi2lo-CFD $[g]$ & Rel Diff \% \\
\hline
1	 & 2.4316e+00 & 1.4232e+00 & 1.1899e+00 & -2.3330e-01 & -16.4\\
2	 & 2.1537e+00 & 9.8041e-01 & 5.9479e-01 & -3.8562e-01 & -39.3\\
3	 & 1.9302e+00 & 6.1962e-01 & 6.4702e-01 & 2.7400e-02 &  4.4\\
4	 & 1.9040e+00 & 1.0737e+00 & 5.6557e-01 & -5.0813e-01 &  $\mathbf{-47.3}$\\
5	 & 1.7982e+00 & 3.6318e-01 & 4.3346e-01 & 7.0280e-02 &  19.4\\
6	 & 7.6893e-01 & 1.7713e-01 & 1.9431e-01 & 1.7180e-02 &  9.7\\
7	 & 1.5980e-01 & 7.9597e-02 & 7.4350e-02 & -5.2470e-03 & -6.6\\
8	 & 1.3032e-01 & 5.9122e-02 & 6.6394e-02 & 7.2720e-03 &  12.3\\
9	 & 1.3329e-01 & 6.6094e-02 & 6.5574e-02 & -5.2000e-04 & -0.8\\
10	 &1.3259e-01 & 7.1162e-02 & 5.5866e-02 & -1.5296e-02  & -21.5\\
11	 &1.7213e-01 & 7.9487e-02 & 7.5059e-02 & -4.4280e-03  & -5.6\\
12	 &8.8404e-01 & 2.2533e-01 & 1.5989e-01 & -6.5440e-02  & -29.0\\
13	 &2.0002e+00 & 4.3636e-01 & 5.1048e-01 & 7.4120e-02 & 17.0\\
14	 &1.9970e+00 & 5.2130e-01 & 7.4719e-01 & 2.2589e-01 & 43.3\\
15	 &1.9474e+00 & 8.4999e-01 & 6.2756e-01 & -2.2243e-01  & -26.2\\
16	 &2.1787e+00 & 5.6215e-01 & 8.1922e-01 & 2.5707e-01 & 45.7\\
17	 &1.7124e+00 & 5.0727e-01 & 5.0361e-01 & -3.6600e-03  & -0.7\\
18	 &1.3477e+00 & 4.4664e-01 & 3.8244e-01 & -6.4200e-02  & -14.4\\
19	 &1.1573e+00 & 2.1674e-01 & 2.7412e-01 & 5.7380e-02 & 26.5\\
20	 &3.1488e-01 & 1.4063e-01 & 9.6251e-02 & -4.4379e-02  & -31.6\\
21	 &2.4285e-01 & 8.9271e-02 & 8.6669e-02 & -2.6020e-03  & -2.9\\
22	 &3.2634e-01 & 8.7701e-02 & 1.2055e-01 & 3.2849e-02 & 37.5\\
23	 &1.1797e+00 & 2.8810e-01 & 2.2075e-01 & -6.7350e-02  & -23.4\\
24	 &1.3379e+00 & 3.5204e-01 & 4.0989e-01 & 5.7850e-02 & 16.4\\
25	 &7.8681e-01 & 2.5506e-01 & 1.6677e-01 & -8.8290e-02  & -34.6\\
\hline \hline
Totals	 & 2.9128e+01 & 9.9713e+00 & 9.0877e+00 & -8.8360e-01  & -8.9\\
\hline
\end{tabular}
\label{tab:loo_crud_cmass}
\end{center}
\end{table}


At each re-sample step the crud mass was summed over all pins in the assembly and presented in figure \ref{fig:asmcmasstime}.  The total assembly crud mass predicted by CFD and the hi2lo model are in in close agreement.  At 300 days simulation time the relative difference in the crud mass results between the hi2lo and the CFD model was -8.9\%, as shown in table \ref{tab:loo_crud_cmass}.

\begin{figure}[]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/asm_cmass_time}
    \caption{Assembly integrated CTF vs CFD vs Hi2lo crud mass as a function of time.}
    \label{fig:asmcmasstime}
\end{figure}

The RMS axial crud distribution errors are summarized in table \ref{tab:loo_rms}.  To facilitate examination of the hi2lo model predictions for geometric biases across the assembly top-down views of the RMS crud mass and boron mass error distributions were generated and presented in figure \ref{fig:l2boronasmerrorshmap} and \ref{fig:l2cmassasmerrorshmap} respectively.  The pins which reside on the edge of the assembly did not exhibit any increase in crud error on average.  The root mean squared error is given by: $RMS = \sqrt{\frac{1}{J}\sum^J_j(\mathrm{Hi2lo}_j - \mathrm{CFD}_j)^2}$ where $j$ is the CTF face index on a given pin.

% RMS error table
\begin{table}[h]
    \begin{center}
        \caption[Hi2lo crud RMS summary.]{Hi2lo vs CFD crud RMS summary.}
    \begin{tabular}[h]{|c|C|C|}
        \hline
        Pin  & Axial RMS Error Crud Mass $[g/cm^2]$ & Axial RMS Error Crud Boron Mass $[g/cm^2]$ \\
\hline \hline
1  & 6.2482e-04 &  3.3009e-07  \\
2  & 8.1392e-04 &  4.3183e-07  \\
3  & 2.0189e-04 &  1.0731e-07  \\
4  & $\mathbf{1.0737\mathrm{\bf e-}03}$ &  5.7008e-07  \\
5  & 2.2335e-04 &  1.1847e-07  \\
6  & 6.5623e-05 &  3.4608e-08  \\
7  & 2.1295e-05 &  1.0898e-08  \\
8  & 1.8572e-05 &  9.4019e-09  \\
9  & 1.0839e-05 &  5.4659e-09  \\
10 & 2.4348e-05 &  1.2298e-08  \\
11 & 2.9659e-05 &  1.5478e-08  \\
12 & 1.9073e-04 &  1.0111e-07  \\
13 & 3.9831e-04 &  2.1135e-07  \\
14 & 5.0327e-04 &  2.6950e-07  \\
15 & 5.5978e-04 &  2.9813e-07  \\
16 & 5.6026e-04 &  2.9830e-07  \\
17 & 1.2664e-04 &  6.6854e-08  \\
18 & 1.8205e-04 &  9.5976e-08  \\
19 & 1.2838e-04 &  6.8271e-08  \\
20 & 9.7915e-05 &  5.1674e-08  \\
21 & 1.7636e-05 &  9.2180e-09  \\
22 & 6.7042e-05 &  3.5199e-08  \\
23 & 1.7096e-04 &  9.0595e-08  \\
24 & 1.5885e-04 &  8.4133e-08  \\
25 & 1.9995e-04 &  1.0617e-07  \\
\hline
\end{tabular}
\label{tab:loo_rms}
\end{center}
\end{table}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/l2_boron_asm_errors_hmap}
    \caption{5x5 Axial RMS crud boron mass relative error distribution.}
    \label{fig:l2boronasmerrorshmap}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/l2_cmass_asm_errors_hmap}
    \caption{5x5 Axial RMS crud mass relative error distribution.}
    \label{fig:l2cmassasmerrorshmap}
\end{figure}

Consistent under prediction of crud across the assembly was not observed. The top down assembly view of the crud prediction error distribution provided in figures \ref{fig:totbmassrelasmerrorshmap} and \ref{fig:totcmassrelasmerrorshmap} do not exhibit a tilt or other regular geometric pattern.  The hi2lo model over predicts the total amount of crud for some pins in the assembly, particularly pins 14 and 16 but strongly under predicts the total crud in pin 4.  This high variance in the prediction errors can be partially attributed to small training sample size, however a more in depth cross validation should be conducted as part of a future study in which a larger CFD training pool is available.  

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/tot_bmass_rel_asm_errors_hmap}
    \caption{5x5 Integrated crud boron mass relative error distribution.}
    \label{fig:totbmassrelasmerrorshmap}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/tot_boron_asm_errors_hmap}
    \caption{5x5 Integrated crud boron mass absolute error distribution.}
    \label{fig:totboronasmerrorshmap}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/tot_cmass_asm_errors_hmap}
    \caption{5x5 Integrated crud mass absolute error distribution.}
    \label{fig:totcmassasmerrorshmap}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{figs/5x5/imp/tot_cmass_rel_asm_errors_hmap}
    \caption{5x5 Integrated crud mass relative error distribution.}
    \label{fig:totcmassrelasmerrorshmap}
\end{figure}

The correlations between crud prediction errors and errors committed by the quantile regressors were investigated in an attempt to establish performance metrics.  Understanding the correlation of errors between the machine learning model predictions and the crud prediction errors is helpful when identifying the relative importance of the quantities predicted by the machine learning models with respect to crud growth.

Provided sensitivities of the crud results to the ML errors one can estimate the expected accuracy of the crud predictions obtained via the hi2lo model by:

\begin{equation} \nonumber
    E_{c_j} \approx \sum_l \frac{\partial E_{c,j}}{\partial E_{l,j}}E_{l,j}
\end{equation}
Where $E_{c,j}$ is the $j^{th}$ pin crud mass error and $E_l$ is the error associated with the $l^{th}$ component of the ML model predictions.  $E_{l,j}$ can be computed at training time, before crud growth simulations are performed.
This allows a user of the hi2lo model to detect problems with the trained quantile regression and copula models prior to employing the model to make crud predictions.

A Student-T test was conducted on the slope of each fitted linear trend lines. The results of the Student-T tests are shown in the upper-triangle of figure \ref{fig:asmerrorcorr}.  The null hypothesis was taken to be a slope of zero.  The standard deviation of the computed sensitivities is high when using a small sample size making it difficult to rigorously conclude that errors made by the machine learning models correspond to errors in the crud predictions.
% One can conclude that a  sample size greater than 25 pins should be used in future work to investigate the relative influence of machine learning errors on the predicted crud errors

\begin{figure}[H]
    \centering
    \includegraphics[width=0.95\linewidth]{figs/5x5/imp/asm_error_corr}
    \caption{Correlation of ML errors with crud prediction errors.}
    \label{fig:asmerrorcorr}
\end{figure}

Statistically significant trends were found between the RMS error committed by the TKE quantile regressors and the crud boron and mass distribution errors, as measured by root-mean-squared error.  This suggests there is a link between being able to accurately predict the conditional quantiles of the TKE distributions and obtaining accurate crud estimates.

A strong positive correlation was observed between the root-mean-squared crud errors and the total crud mass prediction errors.  This is a trivial result since one expects pins which exhibited large axial crud distriubtion RMS errors would also be likely to experience a large total integrated crud mass error unless, by happenstance, there was a cancellation of errors.


\section{Section Takeaways}


\begin{itemize}
    \item Crud predictions made by the hi2lo model were compared against CFD/crud coupled results and stanalone CTF/crud results.  The Hi2lo model produced crud results closer to the CFD result than the CTF result, as anticipated.  The overall crud mass results for the 5x5 assembly favorably compared against the gold-standard CFD assembly integrated results.
    \item A leave-one-out cross validation strategy was utilized to estimate the predictive performance of the model.
    \item The prediction accuracy of the temperature and TKE quantile regression models was summarized though Q-Q plots for each pin in the LOO cross validation study.
    \item The prediction accuracy of the Kendall's $\tau$ regression model was assessed using the root-mean-square error for each pin in the LOO cross validation study.  \item Correlations between the errors committed by the machine learning models and the crud prediction errors were computed.  High uncertainty associated with these correlation measures did not permit a statistically significant link between poor Kendall's $\tau$ predictive performance and poor crud predictions to be drawn.
        \item The copula classifier performed poorly given the current set of considered explanatory variables and limited size of the training data set.  A Gaussian copula was assumed on each CTF face in place of the poorly predicted copula family from the classifier.  Recalling the results shown in section \ref{sec:crud_copula_sensi}, this is not expected to reduce crud prediction accuracy.
\end{itemize}
